# 11. アプリケーション・フレームワーク

## 11.1. 深層学習フレームワーク

ABCIシステムで深層学習フレームワークを利用する場合、
利用者がホーム領域またはグループ領域にインストールする必要があります。
深層学習フレームワークのインストール方法は以下の通りです。

### 11.1.1 Caffe

[Caffe](http://caffe.berkeleyvision.org/)のインストール方法は以下を参照ください。

```
INSTALL_DIR : インストールディレクトリのパス

[username@g0001 ~]$ cd INSTALL_DIR
[username@g0001 ~]$ module load python/2.7/2.7.15 cuda/9.1/9.1.85.3 cudnn/7.0/7.0.5
[username@g0001 ~]$ git clone https://github.com/BVLC/caffe
[username@g0001 ~]$ cd caffe
[username@g0001 caffe]$ cp Makefile.config.example Makefile.config
[username@g0001 caffe]$ vi Makefile.config
[username@g0001 caffe]$ make all 2>&1 > log_make-all.txt
[username@g0001 caffe]$ make test 2>&1 > log_make-test.txt
[username@g0001 caffe]$ make runtest 2>&1 > log_make-runtest.txt
[username@g0001 caffe]$ pip install -r python/requirements.txt
[username@g0001 caffe]$ make pycaffe
[username@g0001 caffe]$ make distibute
```

### 11.1.2 Caffe2 

[Caffe2](https://caffe2.ai/)のインストール方法は以下を参照ください。

```
INSTALL_DIR : インストールディレクトリのパス

[username@g0001 ~]$ export PREFIX=INSTALL_DIR
[username@g0001 ~]$ module load python/3.6/3.6.5 cuda/9.1/9.1.85.3 cudnn/7.0/7.0.5 nccl/2.1/2.1.15-1
[username@g0001 ~]$ git clone https://github.com/gflags/gflags.git
[username@g0001 ~]$ mkdir gflags/build && cd gflags/build
[username@g0001 build]$ cmake3 -DBUILD_SHARED_LIBS=ON -DCMAKE_CXX_FLAGS='-fPIC' -DCMAKE_INSTALL_PREFIX=$PREFIX .. 
[username@g0001 build]$ make -j 8 2>&1 | tee make.log 
[username@g0001 build]$ make install 2>&1 | tee make_install.log
[username@g0001 build]$ cd 

[username@g0001 ~]$ git clone https://github.com/google/glog
[username@g0001 ~]$ cd glog
[username@g0001 glog]$ sh autogen.sh
[username@g0001 glog]$ CXXFLAGS="-fPIC -I$PREFIX/include" LDFLAGS="-L$PREFIX/lib" ./configure --prefix=$PREFIX 2>&1 | tee configure.log
[username@g0001 glog]$ make -j 8 2>&1 | tee make.log
[username@g0001 glog]$ make install 2>&1 | tee make_install.log
[username@g0001 glog]$ cd 

[username@g0001 ~]$ pip3 install future graphviz hypothesis jupyter matplotlib numpy protobuf pydot python-nvd3 pyyaml requests scikit-image scipy six --prefix=$PREFIX
[username@g0001 ~]$ export CUDNN_INCLUDE_DIR=$CUDNN_HOME/include
[username@g0001 ~]$ export CUDNN_LIBRARY=$CUDNN_HOME/lib64/libcudnn.so.7.0.5
[username@g0001 ~]$ export NCCL_INCLUDE_DIR=$NCCL_HOME/include
[username@g0001 ~]$ export NCCL_LIBRARY=$NCCL_HOME/lib/libnccl.so.2.1.15
[username@g0001 ~]$ git clone --recursive https://github.com/pytorch/pytorch.git
[username@g0001 ~]$ cd pytorch && git submodule update --init
[username@g0001 pytorch]$ mkdir build && cd build
[username@g0001 build]$ cmake3 -DPYTHON_INCLUDE_DIR=/apps/python/3.6.5/include/python3.6m -DPYTHON_EXECUTABLE=/apps/python/3.6.5/bin/python3 -DPYTHON_LIBRARY=/apps/python/3.6.5/lib -DNCCL_INCLUDE_DIR=$NCCL_INCLUDE_DIR -DNCCL_LIBRARY=$NCCL_LIBRARY -DUSE_OPENCV=ON -DCMAKE_INSTALL_PREFIX=INSTALL_DIR .
[username@g0001 build]$ make install 2>&1 | tee make_install.log
```

### 11.1.3 TensorFlow-GPU

#### 11.1.3.1 シングルGPU

##### 11.1.3.1.1 導入方法

[TensorFlow](https://www.tensorflow.org/)のインストール方法は以下を参照ください。

```
NEW_VENV : インストールするPython仮想環境、またはディレクトリパス
[username@es1 ~]$ qrsh -g グループ名 -l rt_F=1
[username@g0001 ~]$ module load python/3.6/3.6.5 cuda/9.0/9.0.176.4 cudnn/7.2/7.2.1
[username@g0001 ~]$ export LD_LIBRARY_PATH=$CUDA_HOME/extras/CUPTI/lib64:$LD_LIBRARY_PATH
[username@g0001 ~]$ export NEW_VENV=${HOME}/venv/tensorflow-gpu
[username@g0001 ~]$ python3 -m venv ${NEW_VENV}
[username@g0001 ~]$ source ${NEW_VENV}/bin/activate
(tensorflow-gpu) [username@g0001 ~]$ pip3 install tensorflow-gpu==1.12.0
```

##### 11.1.3.1.2 実行方法


#### 11.1.3.2 シングルノードマルチGPU

##### 11.1.3.2.1 導入方法

horovodを利用したtensorflow並列環境の構築
```
NEW_VENV : インストールするPython仮想環境、またはディレクトリパス

[username@es1 ~]$ qrsh -g グループ名 -l rt_F=1
[username@g0001 ~]$ module load python/3.6/3.6.5 cuda/9.0/9.0.176.4 cudnn/7.2/7.2.1 nccl/2.3/2.3.7-1 openmpi/2.1.5
[username@g0001 ~]$ export LD_LIBRARY_PATH=$CUDA_HOME/extras/CUPTI/lib64:$LD_LIBRARY_PATH
[username@g0001 ~]$ export NEW_VENV=${HOME}/venv/tensorflow-gpu
[username@g0001 ~]$ python3 -m venv ${NEW_VENV}
[username@g0001 ~]$ source ${NEW_VENV}/bin/activate
(NEW_VENV) [username@g0001 ~]$ pip3 install tensorflow-gpu==1.12.0
(NEW_VENV) [username@g0001 ~]$ HOROVOD_NCCL_HOME=$NCCL_HOME HOROVOD_GPU_ALLREDUCE=NCCL pip3 install horovod
```

##### 11.1.3.2.2 実行方法

サンプルプログラムのダウンロード
```
[username@g0001 ~]$ wget https://raw.githubusercontent.com/uber/horovod/master/examples/tensorflow_mnist.py
```

ジョブ投入スクリプト(ノード内4gpuを使用してtensorflow_mnist.pyを実行するジョブスクリプト例)
```
[username@es ~]$ cat submit.sh
#!/bin/sh

#$ -l rt_F=1
#$ -l h_rt=1:23:45
#$ -j y
#$ -cwd

source /etc/profile.d/modules.sh
module load python/3.6/3.6.5 cuda/9.0/9.0.176.4 cudnn/7.2/7.2.1 nccl/2.3/2.3.7-1 openmpi/2.1.5
export NEW_VENV=${HOME}/venv/tensorflow-gpu
source ${NEW_VENV}/bin/activate

NUM_NODES=${NHOSTS}
NUM_GPUS_PER_NODE=4
NUM_GPUS_PER_SOCKET=$(expr ${NUM_GPUS_PER_NODE} / 2)
NUM_PROCS=$(expr ${NUM_NODES} \* ${NUM_GPUS_PER_NODE})

MPIOPTS="-n ${NUM_PROCS} -map-by ppr:${NUM_GPUS_PER_NODE}:node -x PATH -x LD_LIBRARY_PATH"

APP="python3 $HOME/tensorflow_mnist.py"
          
mpiexec ${MPIOPTS} ${APP}
```

ジョブ投入(2ノードでそれぞれ4gpuを利用する場合)
```
GROUP    : ABCI利用グループ

[username@es ~]$ qsub -g GROUP submit.sh
```

#### 11.1.3.3 マルチノードマルチGPU

##### 11.1.3.3.1 導入方法

horovodを利用したtensorflow並列環境の構築
```
NEW_VENV : インストールするPython仮想環境、またはディレクトリパス

[username@g0001 ~]$ module load python/3.6/3.6.5 cuda/9.0/9.0.176.4 cudnn/7.2/7.2.1 nccl/2.3/2.3.7-1 openmpi/2.1.5
[username@g0001 ~]$ export LD_LIBRARY_PATH=$CUDA_HOME/extras/CUPTI/lib64:$LD_LIBRARY_PATH
[username@g0001 ~]$ python3 -m venv NEW_VENV
[username@g0001 ~]$ source NEW_VENV/bin/activate
(NEW_VENV) [username@g0001 ~]$ pip3 install tensorflow-gpu==1.12.0
(NEW_VENV) [username@g0001 ~]$ HOROVOD_NCCL_HOME=$NCCL_HOME HOROVOD_GPU_ALLREDUCE=NCCL pip3 install horovod
```

##### 11.1.3.3.2 実行方法

サンプルプログラムのダウンロード
```
[username@es ~]$ wget https://raw.githubusercontent.com/uber/horovod/master/examples/tensorflow_mnist.py
```

ジョブ投入スクリプト(ノード内4gpuを使用してtensorflow_mnist.pyを実行するジョブスクリプト例)
```
[username@es ~]$ cat submit.sh
#!/bin/sh

#$ -l rt_F=2
#$ -l h_rt=1:23:45
#$ -j y
#$ -cwd

source /etc/profile.d/modules.sh
module load python/3.6/3.6.5 cuda/9.0/9.0.176.4 cudnn/7.2/7.2.1 nccl/2.3/2.3.7-1 openmpi/2.1.5
source $HOME/NEW_VENV/bin/activate

NUM_NODES=${NHOSTS}
NUM_GPUS_PER_NODE=4
NUM_GPUS_PER_SOCKET=$(expr ${NUM_GPUS_PER_NODE} / 2)
NUM_PROCS=$(expr ${NUM_NODES} \* ${NUM_GPUS_PER_NODE})

MPIOPTS="-n ${NUM_PROCS} -map-by ppr:${NUM_GPUS_PER_NODE}:node -x PATH -x LD_LIBRARY_PATH"

APP="python3 $HOME/tensorflow_mnist.py"
          
mpiexec ${MPIOPTS} ${APP}
```

ジョブ投入(2ノードでそれぞれ4gpuを利用する場合)
```
GROUP    : ABCI利用グループ

[username@es ~]$ qsub -g GROUP submit.sh
```


Singularity環境で実行する場合
```
SINGULARITY_IMAGE_PATH   : Sigularityイメージのパス

[username@es ~]$ cat submit_singularity.sh
#!/bin/sh                                                                                           

source /etc/profile.d/modules.sh
module load singularity/2.6.1 openmpi/2.1.5

NUM_NODES=${NHOSTS}
NUM_GPUS_PER_NODE=4
NUM_GPUS_PER_SOCKET=$(expr ${NUM_GPUS_PER_NODE} / 2)
NUM_PROCS=$(expr ${NUM_NODES} \* ${NUM_GPUS_PER_NODE})

MPIOPTS="-n ${NUM_PROCS} -map-by ppr:${NUM_GPUS_PER_NODE}:node -x PATH -x LD_LIBRARY_PATH"

APP="python3 $HOME/tensorflow_mnist.py"
          

mpiexec ${MPIOPTS} singularity exec --nv ${SINGULARITY_IMAGE_PATH} ${APP}
```

ジョブ投入(2ノードでそれぞれ4gpuを利用する場合)
```
GROUP    : ABCI利用グループ

[username@es ~]$ qsub -g GROUP -l rt_F=2 submit_singularity.sh
```

### 11.1.4 Theano 

[Theano](http://deeplearning.net/software/theano/)のインストール方法は以下のページを参照ください。

[How to install Theano](http://deeplearning.net/software/theano/)

### 11.1.5 Torch 

[Torch](http://torch.ch/)のインストール方法は以下を参照ください。

```
INSTALL_DIR : インストールディレクトリのパス
INSTALL_DIR_OPENBLAS : インストールディレクトリのパス

[username@g0001 ~]$ module load cuda/9.1/9.1.85.3
[username@g0001 ~]$ git clone https://github.com/xianyi/OpenBLAS.git
[username@g0001 ~]$ make TARGET=HASWELL NO_AFFINITY=1 USE_OPENMP=1 > log_make_20180621-00.txt 2>&1
[username@g0001 ~]$ make install PREFIX=INSTALL_DIR_OPENBLAS > log_make_inst_20180621-00.txt  2>&1
[username@g0001 ~]$ export LD_LIBRARY_PATH=INSTALL_DIR_OPENBLAS/lib:$LD_LIBRARY_PATH
[username@g0001 ~]$ git clone https://github.com/torch/distro.git ./torch --recursive
[username@g0001 ~]$ export TORCH_NVCC_FLAGS="-D__CUDA_NO_HALF_OPERATORS__"
[username@g0001 ~]$ TORCH_LUA_VERSION=LUA51 PREFIX=INSTALL_DIR ./install.sh
```

### 11.1.6 PyTorch 

[PyTorch](https://pytorch.org/)のインストール方法は以下を参照ください。

```
NEW_VENV : インストールするPython仮想環境、またはディレクトリパス

[username@g0001 ~]$ module load python/3.6/3.6.5 cuda/9.1/9.1.85.3
[username@g0001 ~]$ python3 -m venv NEW_VENV
[username@g0001 ~]$ source NEW_VENV/bin/activate
(NEW_VENV) [username@g0001 ~]$ pip3 install torch torchvision
```

### 11.1.7 CNTK 

[CNTK](https://www.microsoft.com/en-us/cognitive-toolkit/)のインストール方法は以下のページを参照ください。

[How to install CNTK](https://www.microsoft.com/en-us/cognitive-toolkit/)

### 11.1.8 MXNet

[MXNet](https://mxnet.apache.org/)のインストール方法は以下を参照ください。

```
NEW_VENV : インストールするPython仮想環境、またはディレクトリパス

[username@g0001 ~]$ module load python/3.6/3.6.5 cuda/9.2/9.2.148.1
[username@g0001 ~]$ python3 -m venv NEW_VENV
[username@g0001 ~]$ source NEW_VENV/bin/activate
(NEW_VENV) [username@g0001 ~]$ pip3 install mxnet-cu92
```

### 11.1.9 Chainer 

[Chainer](https://chainer.org/)のインストール方法は以下を参照ください。
```
NEW_VENV : インストールするPython仮想環境、またはディレクトリパス

[username@g0001 ~]$ module load python/3.6/3.6.5 cuda/9.1/9.1.85.3 cudnn/7.0/7.0.5
[username@g0001 ~]$ python3 -m venv NEW_VENV
[username@g0001 ~]$ source NEW_VENV/bin/activate
(NEW_VENV) [username@g0001 ~]$ pip3 install cupy-cuda91 chainer
```

サンプルプログラムのダウンロード
```
[username@es ~]$ git clone https://github.com/chainer/chainer.git chainer_sample
[username@es ~]$ cd chiner_sample/examples/chainermn/mnist
[username@es mnist]$ ls
README.md          model_parallel.png    train_mnist_checkpoint.py     train_mnist_model_parallel.py
dual_parallel.png  parallelism_axis.png  train_mnist.py                train_mnist_dual_parallel.py
```

ジョブ投入スクリプト(4gpuを使用してtrain_mnist.pyを実行するジョブスクリプト例)
```
[username@es ~]$ cat submit.sh
#!/bin/bash

source /etc/profile.d/modules.sh
module load python/3.6/3.6.5 cuda/9.1/9.1.85.3 cudnn/7.0/7.0.5
module load openmpi/2.1.5
source $HOME/NEW_VENV/bin/activate

NUM_NODES=${NHOSTS}
NUM_GPUS_PER_NODE=4
NUM_GPUS_PER_SOCKET=$(expr ${NUM_GPUS_PER_NODE} / 2)
NUM_PROCS=$(expr ${NUM_NODES} \* ${NUM_GPUS_PER_NODE})

MPIOPTS="-np ${NUM_PROCS} --map-by ppr:${NUM_GPUS_PER_SOCKET}:socket --mca mpi_warn_on_fork 0 -x PATH -x LD_LIBRARY_PATH"

APP="python $HOME/chainer_sample/examples/chainermn/mnist/train_mnist.py"

mpiexec ${MPIOPTS} ${APP}  --gpu
```

ジョブ投入(2ノードでそれぞれ4gpuを利用する場合)
```
GROUP    : ABCI利用グループ

[username@es ~]$ qsub -g GROUP -l rt_F=2 submit.sh
```

### 11.1.10 Keras 

#### 11.1.10.1 シングルGPU

##### 11.1.10.1.1 導入方法
(未検証)
TensorFlowをバックエンドとして使う[Keras](https://keras.io/ja/)のインストール方法は以下を参照ください。

```
NEW_VENV : python virtual environment or path to be installed

[username@g0001 ~]$ module load python/3.6/3.6.5 cuda/9.0/9.0.176.4 cudnn/7.2/7.2.1
[username@g0001 ~]$ export LD_LIBRARY_PATH=$CUDA_HOME/extras/CUPTI/lib64:$LD_LIBRARY_PATH
[username@g0001 ~]$ python3 -m venv NEW_VENV
[username@g0001 ~]$ source NEW_VENV/bin/activate
(NEW_VENV) [username@g0001 ~]$ pip3 install tensorflow-gpu
(NEW_VENV) [username@g0001 ~]$ pip3 install keras
```

詳細は[Keras](https://keras.io/ja/)を参照してください。

##### 11.1.10.1.2 実行方法

#### 11.1.10.2 シングルノードマルチGPU

##### 11.1.10.2.1 導入方法
```
NEW_VENV : python virtual environment or path to be installed

[username@g0001 ~]$ module load python/3.6/3.6.5 cuda/9.0/9.0.176.4 cudnn/7.2/7.2.1 nccl/2.3/2.3.7-1 openmpi/2.1.5
[username@g0001 ~]$ export LD_LIBRARY_PATH=$CUDA_HOME/extras/CUPTI/lib64:$LD_LIBRARY_PATH
                    export NEW_VENV="${HOME}/venv/keras"
[username@g0001 ~]$ python3 -m venv ${NEW_VENV}
[username@g0001 ~]$ source ${NEW_VENV}/bin/activate
(keras) [username@g0001 ~]$ pip3 install tensorflow-gpu==1.12.0
(keras) [username@g0001 ~]$ pip3 install keras
(keras) [username@g0001 ~]$ pip3 install horovod
```

詳細は[Keras](https://keras.io/ja/)を参照してください。

##### 11.1.10.2.2 実行方法

サンプルプログラムのダウンロード
```
[username@es ~]$ wget https://raw.githubusercontent.com/uber/horovod/master/examples/keras_mnist.py
```

ジョブ投入スクリプト(4gpuを使用してkeras_mnist.pyを実行するジョブスクリプト例)
```
[username@es ~]$ cat submit.sh
#!/bin/sh
#$ -l rt_F=1
#$ -l h_rt=1:23:45
#$ -j y
#$ -cwd
source /etc/profile.d/modules.sh
module load python/3.6/3.6.5 cuda/9.0/9.0.176.4 cudnn/7.2/7.2.1 nccl/2.3/2.3.7-1 openmpi/2.1.5
export NEW_VENV=${HOME}/venv/keras
source ${NEW_VENV}/bin/activate
NUM_NODES=${NHOSTS}
NUM_GPUS_PER_NODE=4
NUM_GPUS_PER_SOCKET=$(expr ${NUM_GPUS_PER_NODE} / 2)
NUM_PROCS=$(expr ${NUM_NODES} \* ${NUM_GPUS_PER_NODE})
MPIOPTS="-n ${NUM_PROCS} -map-by ppr:${NUM_GPUS_PER_NODE}:node -x PATH -x LD_LIBRARY_PATH"
APP="python3 ${NEW_VENV}/keras_mnist.py"

mpiexec ${MPIOPTS} ${APP}
```

ジョブの投入方法
```
qsub -g gaa50004 submit.sh
```

##### 11.1.10.1.2 実行方法

#### 11.1.10.3 マルチノードマルチGPU

##### 11.1.10.3.1 導入方法
```
NEW_VENV : python virtual environment or path to be installed

[username@g0001 ~]$ module load python/3.6/3.6.5 cuda/9.0/9.0.176.4 cudnn/7.2/7.2.1 nccl/2.3/2.3.7-1 openmpi/2.1.5
[username@g0001 ~]$ export LD_LIBRARY_PATH=$CUDA_HOME/extras/CUPTI/lib64:$LD_LIBRARY_PATH
                    export NEW_VENV="${HOME}/venv/keras"
[username@g0001 ~]$ python3 -m venv ${NEW_VENV}
[username@g0001 ~]$ source ${NEW_VENV}/bin/activate
(keras) [username@g0001 ~]$ pip3 install tensorflow-gpu==1.12.0
(keras) [username@g0001 ~]$ pip3 install keras
(keras) [username@g0001 ~]$ pip3 install horovod
```

詳細は[Keras](https://keras.io/ja/)を参照してください。

##### 11.1.10.3.2 実行方法

サンプルプログラムのダウンロード
```
[username@es ~]$ wget https://raw.githubusercontent.com/uber/horovod/master/examples/keras_mnist.py
```

ジョブ投入スクリプト(2ノードでそれぞれ4gpuを使用してkeras_mnist.pyを実行するジョブスクリプト例)
```
[username@es ~]$ cat submit.sh
#!/bin/sh
#$ -l rt_F=2
#$ -l h_rt=1:23:45
#$ -j y
#$ -cwd
source /etc/profile.d/modules.sh
module load python/3.6/3.6.5 cuda/9.0/9.0.176.4 cudnn/7.2/7.2.1 nccl/2.3/2.3.7-1 openmpi/2.1.5
export NEW_VENV=${HOME}/venv/keras
source ${NEW_VENV}/bin/activate
NUM_NODES=${NHOSTS}
NUM_GPUS_PER_NODE=4
NUM_GPUS_PER_SOCKET=$(expr ${NUM_GPUS_PER_NODE} / 2)
NUM_PROCS=$(expr ${NUM_NODES} \* ${NUM_GPUS_PER_NODE})
MPIOPTS="-n ${NUM_PROCS} -map-by ppr:${NUM_GPUS_PER_NODE}:node -x PATH -x LD_LIBRARY_PATH"
APP="python3 ${NEW_VENV}/keras_mnist.py"

mpiexec ${MPIOPTS} ${APP}
```

ジョブの投入方法
```
qsub -g gaa50004 submit.sh
```

## 11.2. ビッグデータ解析フレームワーク

### 11.2.1 Hadoop

ABCIシステムではHadoopが利用可能です。 利用するためには事前に`module`コマンドを用いて利用環境を設定する必要があります。 

Hadoopの環境設定
```
$ module load openjdk/1.8.0.131
$ module load hadoop/2.9.1
```

Hadoopの実行サンプル

```
[username@es1 ~]$ qrsh -l rt_F=1
[username@g0001~]$ module load openjdk/1.8.0.131
[username@g0001~]$ module load hadoop/2.9.1
[username@g0001~]$ mkdir input
[username@g0001~]$ cp /apps/hadoop/2.9.1/etc/hadoop/*.xml input
[username@g0001~]$ hadoop jar /apps/hadoop/2.9.1/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.9.1.jar grep input output 'dfs[a-z.]+'
[username@g0001~]$ cat output/part-r-00000
1       dfsadmin
```

