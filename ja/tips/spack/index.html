<!doctype html><html lang="ja" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="description" content="ABCI Users Guide, Japanese version"><link rel="canonical" href="https://docs.abci.ai/ja/tips/spack/"><meta name="author" content="AIST"><meta name="lang:clipboard.copy" content="クリップボードへコピー"><meta name="lang:clipboard.copied" content="コピーしました"><meta name="lang:search.language" content="ja"><meta name="lang:search.pipeline.stopwords" content="True"><meta name="lang:search.pipeline.trimmer" content="True"><meta name="lang:search.result.none" content="何も見つかりませんでした"><meta name="lang:search.result.one" content="1件見つかりました"><meta name="lang:search.result.other" content="#件見つかりました"><meta name="lang:search.tokenizer" content="[\s\-　、。，．]+"><link rel="shortcut icon" href="../../assets/images/favicon.png"><meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.3.1"><title>Spackによるソフトウェア管理 - ABCI Users Guide</title><link rel="stylesheet" href="../../assets/stylesheets/application.4031d38b.css"><link rel="stylesheet" href="../../assets/stylesheets/application-palette.224b79ff.css"><meta name="theme-color" content="#ef5350"><script src="../../assets/javascripts/modernizr.74668098.js"></script><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=swap"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel="stylesheet" href="../../assets/fonts/material-icons.css"><script>window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-118371652-2", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })</script><script async src="https://www.google-analytics.com/analytics.js"></script></head><body dir="ltr" data-md-color-primary="red" data-md-color-accent="red"><svg class="md-svg"><defs><svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg></defs></svg> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" data-md-component="overlay" for="__drawer"></label><a href="#spack" tabindex="1" class="md-skip">Skip to content </a><header class="md-header" data-md-component="header"><nav class="md-header-nav md-grid"><div class="md-flex"><div class="md-flex__cell md-flex__cell--shrink"><a href="https://docs.abci.ai/ja/" title="ABCI Users Guide" class="md-header-nav__button md-logo"><i class="md-icon">cloud</i></a></div><div class="md-flex__cell md-flex__cell--shrink"><label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label></div><div class="md-flex__cell md-flex__cell--stretch"><div class="md-flex__ellipsis md-header-nav__title" data-md-component="title"><span class="md-header-nav__topic">ABCI Users Guide</span><span class="md-header-nav__topic">Spackによるソフトウェア管理</span></div></div><div class="md-flex__cell md-flex__cell--shrink"><label class="md-icon md-icon--search md-header-nav__button" for="__search"></label><div class="md-search" data-md-component="search" role="dialog"><label class="md-search__overlay" for="__search"></label><div class="md-search__inner" role="search"><form class="md-search__form" name="search"><input type="text" class="md-search__input" name="query" placeholder="検索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active"> <label class="md-icon md-search__icon" for="__search"></label> <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button></form><div class="md-search__output"><div class="md-search__scrollwrap" data-md-scrollfix><div class="md-search-result" data-md-component="result"><div class="md-search-result__meta">検索キーワードを入力してください</div><ol class="md-search-result__list"></ol></div></div></div></div></div></div><div class="md-flex__cell md-flex__cell--shrink"><div class="md-header-nav__source"><a href="https://github.com/aistairc/abci-docs/" title="リポジトリへ" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">GitHub</div></a></div></div></div></nav></header><div class="md-container"><main class="md-main"><div class="md-main__inner md-grid" data-md-component="container"><div class="md-sidebar md-sidebar--primary" data-md-component="navigation"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--primary" data-md-level="0"><label class="md-nav__title md-nav__title--site" for="__drawer"><a href="https://docs.abci.ai/ja/" title="ABCI Users Guide" class="md-nav__button md-logo"><i class="md-icon">cloud</i></a>ABCI Users Guide</label><div class="md-nav__source"><a href="https://github.com/aistairc/abci-docs/" title="リポジトリへ" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">GitHub</div></a></div><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../.." title="はじめに" class="md-nav__link">はじめに</a></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2"><label class="md-nav__link" for="nav-2">利用手引き</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-2">利用手引き</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../01/" title="1. ABCIシステムの概要" class="md-nav__link">1. ABCIシステムの概要</a></li><li class="md-nav__item"><a href="../../02/" title="2. ABCIシステム利用環境" class="md-nav__link">2. ABCIシステム利用環境</a></li><li class="md-nav__item"><a href="../../03/" title="3. ジョブ実行環境" class="md-nav__link">3. ジョブ実行環境</a></li><li class="md-nav__item"><a href="../../04/" title="4. ストレージ" class="md-nav__link">4. ストレージ</a></li><li class="md-nav__item"><a href="../../05/" title="5. Environment Modulesの利用" class="md-nav__link">5. Environment Modulesの利用</a></li><li class="md-nav__item"><a href="../../06/" title="6. Pythonの利用" class="md-nav__link">6. Pythonの利用</a></li><li class="md-nav__item"><a href="../../07/" title="7. GPUの利用" class="md-nav__link">7. GPUの利用</a></li><li class="md-nav__item"><a href="../../08/" title="8. MPIの利用" class="md-nav__link">8. MPIの利用</a></li><li class="md-nav__item"><a href="../../09/" title="9. Linuxコンテナ" class="md-nav__link">9. Linuxコンテナ</a></li><li class="md-nav__item"><a href="../../10/" title="10. プログラム開発環境" class="md-nav__link">10. プログラム開発環境</a></li><li class="md-nav__item"><a href="../../appendix1/" title="付録1. インストール済みソフトウェアの構成" class="md-nav__link">付録1. インストール済みソフトウェアの構成</a></li><li class="md-nav__item"><a href="../../appendix2/" title="付録2. HPCIによるABCIシステム利用" class="md-nav__link">付録2. HPCIによるABCIシステム利用</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3"><label class="md-nav__link" for="nav-3">各種アプリケーション</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-3">各種アプリケーション</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../apps/" title="概要" class="md-nav__link">概要</a></li><li class="md-nav__item"><a href="../../apps/tensorflow/" title="TensorFlow" class="md-nav__link">TensorFlow</a></li><li class="md-nav__item"><a href="../../apps/tensorflow-keras/" title="TensorFlow Keras" class="md-nav__link">TensorFlow Keras</a></li><li class="md-nav__item"><a href="../../apps/pytorch/" title="PyTorch" class="md-nav__link">PyTorch</a></li><li class="md-nav__item"><a href="../../apps/mxnet/" title="MXNet" class="md-nav__link">MXNet</a></li><li class="md-nav__item"><a href="../../apps/chainer/" title="Chainer" class="md-nav__link">Chainer</a></li><li class="md-nav__item"><a href="../../apps/others/" title="その他" class="md-nav__link">その他</a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked><label class="md-nav__link" for="nav-4">Tips</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-4">Tips</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../remote-desktop/" title="リモートデスクトップの利用" class="md-nav__link">リモートデスクトップの利用</a></li><li class="md-nav__item"><a href="../awscli/" title="AWS CLIの利用" class="md-nav__link">AWS CLIの利用</a></li><li class="md-nav__item"><a href="../tera-term/" title="Tera Termの利用" class="md-nav__link">Tera Termの利用</a></li><li class="md-nav__item"><a href="../putty/" title="PuTTYの利用" class="md-nav__link">PuTTYの利用</a></li><li class="md-nav__item"><a href="../jupyter-notebook/" title="Jupyter Notebookの利用" class="md-nav__link">Jupyter Notebookの利用</a></li><li class="md-nav__item"><a href="../sregistry-cli/" title="Singularity Global Clientの利用" class="md-nav__link">Singularity Global Clientの利用</a></li><li class="md-nav__item md-nav__item--active"><input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc"><label class="md-nav__link md-nav__link--active" for="__toc">Spackによるソフトウェア管理</label><a href="./" title="Spackによるソフトウェア管理" class="md-nav__link md-nav__link--active">Spackによるソフトウェア管理</a><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">目次</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#setup-spack" title="Spack環境設定" class="md-nav__link">Spack環境設定</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#install" title="インストール" class="md-nav__link">インストール</a></li><li class="md-nav__item"><a href="#configuration-for-abci" title="ABCI用設定" class="md-nav__link">ABCI用設定</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#adding-compilers" title="コンパイラの登録" class="md-nav__link">コンパイラの登録</a></li><li class="md-nav__item"><a href="#adding-abci-software" title="ABCIソフトウェアの登録" class="md-nav__link">ABCIソフトウェアの登録</a></li></ul></nav></li></ul></nav></li><li class="md-nav__item"><a href="#basic-of-spack" title="Spack 基本操作" class="md-nav__link">Spack 基本操作</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#compiler-operations" title="コンパイラ関連" class="md-nav__link">コンパイラ関連</a></li><li class="md-nav__item"><a href="#software-management-operations" title="ソフトウェア管理関連" class="md-nav__link">ソフトウェア管理関連</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#install" title="インストール" class="md-nav__link">インストール</a></li><li class="md-nav__item"><a href="#uninstall" title="アンインストール" class="md-nav__link">アンインストール</a></li><li class="md-nav__item"><a href="#information" title="情報確認" class="md-nav__link">情報確認</a></li></ul></nav></li><li class="md-nav__item"><a href="#use-of-installed-software" title="ソフトウェア利用方法" class="md-nav__link">ソフトウェア利用方法</a></li></ul></nav></li><li class="md-nav__item"><a href="#example-software-installation" title="ソフトウェア導入事例" class="md-nav__link">ソフトウェア導入事例</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#cuda-aware-openmpi" title="CUDA-aware OpenMPI" class="md-nav__link">CUDA-aware OpenMPI</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#how-to-install" title="インストール方法" class="md-nav__link">インストール方法</a></li><li class="md-nav__item"><a href="#how-to-use" title="使い方" class="md-nav__link">使い方</a></li></ul></nav></li><li class="md-nav__item"><a href="#cuda-aware-mvapich2" title="CUDA-aware MVAPICH2" class="md-nav__link">CUDA-aware MVAPICH2</a></li><li class="md-nav__item"><a href="#mpifileutils" title="MPIFileUtils" class="md-nav__link">MPIFileUtils</a></li></ul></nav></li></ul></nav></li><li class="md-nav__item"><a href="../datasets/" title="データセットの利用" class="md-nav__link">データセットの利用</a></li><li class="md-nav__item"><a href="../dl-amazon-ecr/" title="Amazon ECR からコンテナ取得" class="md-nav__link">Amazon ECR からコンテナ取得</a></li></ul></nav></li><li class="md-nav__item"><a href="../../ngc/" title="NVIDIA NGC" class="md-nav__link">NVIDIA NGC</a></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6"><label class="md-nav__link" for="nav-6">ABCI クラウドストレージ</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-6">ABCI クラウドストレージ</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../abci-cloudstorage/" title="概要" class="md-nav__link">概要</a></li><li class="md-nav__item"><a href="../../abci-cloudstorage/cs-account/" title="アカウントとアクセスキー" class="md-nav__link">アカウントとアクセスキー</a></li><li class="md-nav__item"><a href="../../abci-cloudstorage/usage/" title="使い方" class="md-nav__link">使い方</a></li><li class="md-nav__item"><a href="../../abci-cloudstorage/encryption/" title="データの暗号化" class="md-nav__link">データの暗号化</a></li><li class="md-nav__item"><a href="../../abci-cloudstorage/acl/" title="アクセス制御（1）" class="md-nav__link">アクセス制御（1）</a></li><li class="md-nav__item"><a href="../../abci-cloudstorage/policy/" title="アクセス制御（2）" class="md-nav__link">アクセス制御（2）</a></li></ul></nav></li><li class="md-nav__item"><a href="../../faq/" title="FAQ" class="md-nav__link">FAQ</a></li><li class="md-nav__item"><a href="../../known-issues/" title="既知の問題" class="md-nav__link">既知の問題</a></li><li class="md-nav__item"><a href="../../system-updates/" title="システム更新履歴" class="md-nav__link">システム更新履歴</a></li><li class="md-nav__item"><a href="https://abci.ai/ja/about_abci/info.html" title="運転状況" class="md-nav__link">運転状況</a></li><li class="md-nav__item"><a href="../../contact/" title="お問い合わせ" class="md-nav__link">お問い合わせ</a></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12"><label class="md-nav__link" for="nav-12">リンク</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-12">リンク</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="https://abci.ai/ja/" title="ABCI Webページ" class="md-nav__link">ABCI Webページ</a></li><li class="md-nav__item"><a href="https://docs.abci.ai/portal/ja/" title="ABCI利用ポータル手引き" class="md-nav__link">ABCI利用ポータル手引き</a></li><li class="md-nav__item"><a href="https://portal.abci.ai/user/project_register_app.php?lang=ja" title="ABCI利用ポータル(利用申請)" class="md-nav__link">ABCI利用ポータル(利用申請)</a></li><li class="md-nav__item"><a href="https://portal.abci.ai/user/login.php?lang=ja" title="ABCI利用ポータル(ログイン)" class="md-nav__link">ABCI利用ポータル(ログイン)</a></li></ul></nav></li><li class="md-nav__item"><a href="https://docs.abci.ai/en/" title="English version" class="md-nav__link">English version</a></li></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component="toc"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">目次</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#setup-spack" title="Spack環境設定" class="md-nav__link">Spack環境設定</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#install" title="インストール" class="md-nav__link">インストール</a></li><li class="md-nav__item"><a href="#configuration-for-abci" title="ABCI用設定" class="md-nav__link">ABCI用設定</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#adding-compilers" title="コンパイラの登録" class="md-nav__link">コンパイラの登録</a></li><li class="md-nav__item"><a href="#adding-abci-software" title="ABCIソフトウェアの登録" class="md-nav__link">ABCIソフトウェアの登録</a></li></ul></nav></li></ul></nav></li><li class="md-nav__item"><a href="#basic-of-spack" title="Spack 基本操作" class="md-nav__link">Spack 基本操作</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#compiler-operations" title="コンパイラ関連" class="md-nav__link">コンパイラ関連</a></li><li class="md-nav__item"><a href="#software-management-operations" title="ソフトウェア管理関連" class="md-nav__link">ソフトウェア管理関連</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#install" title="インストール" class="md-nav__link">インストール</a></li><li class="md-nav__item"><a href="#uninstall" title="アンインストール" class="md-nav__link">アンインストール</a></li><li class="md-nav__item"><a href="#information" title="情報確認" class="md-nav__link">情報確認</a></li></ul></nav></li><li class="md-nav__item"><a href="#use-of-installed-software" title="ソフトウェア利用方法" class="md-nav__link">ソフトウェア利用方法</a></li></ul></nav></li><li class="md-nav__item"><a href="#example-software-installation" title="ソフトウェア導入事例" class="md-nav__link">ソフトウェア導入事例</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#cuda-aware-openmpi" title="CUDA-aware OpenMPI" class="md-nav__link">CUDA-aware OpenMPI</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#how-to-install" title="インストール方法" class="md-nav__link">インストール方法</a></li><li class="md-nav__item"><a href="#how-to-use" title="使い方" class="md-nav__link">使い方</a></li></ul></nav></li><li class="md-nav__item"><a href="#cuda-aware-mvapich2" title="CUDA-aware MVAPICH2" class="md-nav__link">CUDA-aware MVAPICH2</a></li><li class="md-nav__item"><a href="#mpifileutils" title="MPIFileUtils" class="md-nav__link">MPIFileUtils</a></li></ul></nav></li></ul></nav></div></div></div><div class="md-content"><article class="md-content__inner md-typeset"><a href="https://github.com/aistairc/abci-docs/edit/master/ja/docs/tips/spack.md" title="編集" class="md-icon md-content__icon">&#xE3C9;</a><h1 id="spack">Spackによるソフトウェア管理</h1>
<p><a href="https://spack.io/">Spack</a>とは、Lawrence Livermore National Laboratoryで開発されている高性能計算向けのソフトウェアパッケージ管理システムです。
Spackを使うことにより、同一ソフトウェアをバージョン、設定、コンパイラを様々に変えて複数ビルドし、切り替えて使うことができます。
ABCI上でSpackを使うことにより、ABCIが標準でサポートしていないソフトウェアを簡単にインストールすることができるようになります。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>動作確認は2020年2月3日に行っており、その時の最新のバージョンである0.13.3を使用しています。</p>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Spackは、Spackをインストールしたディレクトリ以下にソフトウェアをインストールします。
多数のソフトウェアを導入すると多くの容量を消費しますので、使わなくなったソフトウェアはアンインストールするなどの管理をしてください。</p>
</div>
<h2 id="setup-spack">Spack環境設定</h2>
<h3 id="install">インストール</h3>
<p>GitHubからcloneし、使用するバージョンをcheckoutすることで、Spackをインストールすることができます。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ git clone https://github.com/spack/spack.git</span>
<span class="err">[username@es1 ~]$ cd ./spack</span>
<span class="err">[username@es1 ~/spack]$ git checkout v0.13.3</span>
</code></pre></div>


<p>以降はターミナル上で、Spackを有効化するスクリプトを読み込めば使えます。</p>
<div class="codehilite"><pre><span></span><code>[username@es1 ~]$ source <span class="cp">${</span><span class="n">HOME</span><span class="cp">}</span>/spack/share/spack/setup-env.sh
</code></pre></div>


<h3 id="configuration-for-abci">ABCI用設定</h3>
<h4 id="adding-compilers">コンパイラの登録</h4>
<p>Spackで使用するコンパイラをSpackに登録します。
<code>spack compiler find</code>コマンドで登録できます。</p>
<p>ここでは、ABCIが提供するGCC 4.4.7と4.8.5、7.4.0を登録します。
GCC 4.4.7と4.8.5は標準のパス（/usr/bin）に入っているため、Spackが自動的に見つけます。
GCC 7.4.0はモジュールとして提供されているため、<code>module load</code>する必要があります。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ module load gcc/7.4.0</span>
<span class="err">[username@es1 ~]$ spack compiler find</span>
<span class="err">[username@es1 ~]$ module purge</span>
</code></pre></div>


<p>Spackに登録されているコンパイラを表示するコマンド<code>spack compiler list</code>を実行し、以下のように出力されれば、登録されていることが確認できます。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">es1</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">compiler</span> <span class="n">list</span>
<span class="o">==&gt;</span> <span class="n">Available</span> <span class="n">compilers</span>
<span class="o">--</span> <span class="n">gcc</span> <span class="n">centos7</span><span class="o">-</span><span class="n">x86_64</span> <span class="o">-------------------------------------------</span>
<span class="n">gcc</span><span class="mf">@7.4.0</span>  <span class="n">gcc</span><span class="mf">@4.8.5</span>  <span class="n">gcc</span><span class="mf">@4.4.7</span>
</code></pre></div>


<p>コンパイラの設定ファイル<code>$HOME/.spack/linux/compilers.yaml</code>を編集し、GCC 7.4.0のrpathを設定します。</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">snip</span><span class="p">)</span>
<span class="o">-</span> <span class="nl">compiler</span><span class="p">:</span>
    <span class="nl">paths</span><span class="p">:</span>
      <span class="nl">cc</span><span class="p">:</span> <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="mf">7.4.0</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">gcc</span>
      <span class="nl">cxx</span><span class="p">:</span> <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="mf">7.4.0</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">g</span><span class="o">++</span>
      <span class="nl">f77</span><span class="p">:</span> <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="mf">7.4.0</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">gfortran</span>
      <span class="nl">fc</span><span class="p">:</span> <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="mf">7.4.0</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">gfortran</span>
    <span class="nl">operating_system</span><span class="p">:</span> <span class="n">centos7</span>
    <span class="nl">target</span><span class="p">:</span> <span class="n">x86_64</span>
    <span class="nl">modules</span><span class="p">:</span> <span class="p">[]</span>
    <span class="nl">environment</span><span class="p">:</span> <span class="p">{}</span>
    <span class="nl">extra_rpaths</span><span class="p">:</span>                <span class="o">&lt;-</span> <span class="err">ここを編集</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="mf">7.4.0</span><span class="o">/</span><span class="n">lib64</span>    <span class="o">&lt;-</span> <span class="err">この行を追加</span>
    <span class="nl">flags</span><span class="p">:</span> <span class="p">{}</span>
    <span class="nl">spec</span><span class="p">:</span> <span class="n">gcc</span><span class="mf">@7.4.0</span>
<span class="p">(</span><span class="n">snip</span><span class="p">)</span>
</code></pre></div>


<p>標準で使用するコンパイラは設定ファイル<code>$HOME/.spack/linux/packages.yaml</code>で設定できます。
以下の例では標準コンパイラをgcc 4.8.5に設定しています。</p>
<div class="codehilite"><pre><span></span><code><span class="nl">packages</span><span class="p">:</span>
  <span class="nl">all</span><span class="p">:</span>
    <span class="nl">compiler</span><span class="p">:</span> <span class="p">[</span><span class="n">gcc</span><span class="mf">@4.8.5</span><span class="p">]</span>
</code></pre></div>


<h4 id="adding-abci-software">ABCIソフトウェアの登録</h4>
<p>Spackはソフトウェアの依存関係を解決して、依存するソフトウェアも自動的にインストールします。
標準の設定では、CUDAやOpenMPIなど、ABCIが既に提供しているソフトウェアも利用者ごとにインストールされます。
ディスクスペースの浪費となりますので、ABCIが提供するソフトウェアは、Spackから<em>参照する</em>ように設定することをお勧めします。</p>
<p>Spackが参照するソフトウェアの設定は<code>$HOME/.spack/linux/packages.yaml</code>に定義します。
以下の内容で、そのファイルを作成してください（標準コンパイラの設定も含まれています）。</p>
<div class="codehilite"><pre><span></span><code><span class="nl">packages</span><span class="p">:</span>
  <span class="nl">cuda</span><span class="p">:</span>
    <span class="nl">paths</span><span class="p">:</span>
      <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">8.0.61.2</span><span class="o">:</span>   <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="mf">8.0.61.2</span>
      <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">9.0.176.4</span><span class="o">:</span>  <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="mf">9.0.176.4</span>
      <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">9.1.85.3</span><span class="o">:</span>   <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="mf">9.1.85.3</span>
      <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">9.2.148.1</span><span class="o">:</span>  <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="mf">9.2.148.1</span>
      <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">10.0.130.1</span><span class="o">:</span> <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="mf">10.0.130.1</span>
      <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">10.1.243</span><span class="o">:</span>   <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="mf">10.1.243</span>
      <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">10.2.89</span><span class="o">:</span>    <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="mf">10.2.89</span>
    <span class="nl">buildable</span><span class="p">:</span> <span class="n">False</span>
  <span class="nl">openmpi</span><span class="p">:</span>
    <span class="nl">paths</span><span class="p">:</span>
      <span class="n">openmpi</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">2.1.6</span><span class="o">-</span><span class="n">nocuda</span><span class="o">%</span><span class="n">gcc</span><span class="mf">@4.8.5</span><span class="o">:</span> <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">openmpi</span><span class="o">/</span><span class="mf">2.1.6</span><span class="o">/</span><span class="n">gcc4</span><span class="mf">.8.5</span>
      <span class="n">openmpi</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">3.1.3</span><span class="o">-</span><span class="n">nocuda</span><span class="o">%</span><span class="n">gcc</span><span class="mf">@4.8.5</span><span class="o">:</span> <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">openmpi</span><span class="o">/</span><span class="mf">3.1.3</span><span class="o">/</span><span class="n">gcc4</span><span class="mf">.8.5</span>
  <span class="nl">mvapich2</span><span class="p">:</span>
    <span class="nl">paths</span><span class="p">:</span>
      <span class="n">mvapich2</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">2.3</span><span class="o">-</span><span class="n">nocuda</span><span class="o">%</span><span class="n">gcc</span><span class="mf">@4.8.5</span><span class="o">:</span>   <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">mvapich2</span><span class="o">/</span><span class="mf">2.3</span><span class="o">/</span><span class="n">gcc4</span><span class="mf">.8.5</span>
      <span class="n">mvapich2</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">2.3.2</span><span class="o">-</span><span class="n">nocuda</span><span class="o">%</span><span class="n">gcc</span><span class="mf">@4.8.5</span><span class="o">:</span> <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">mvapich2</span><span class="o">/</span><span class="mf">2.3.2</span><span class="o">/</span><span class="n">gcc4</span><span class="mf">.8.5</span>
  <span class="nl">cmake</span><span class="p">:</span>
    <span class="nl">paths</span><span class="p">:</span>
      <span class="n">cmake</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">3.11.4</span><span class="o">:</span> <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">cmake</span><span class="o">/</span><span class="mf">3.11.4</span>
  <span class="nl">all</span><span class="p">:</span>
    <span class="nl">compiler</span><span class="p">:</span> <span class="p">[</span><span class="n">gcc</span><span class="mf">@4.8.5</span><span class="p">]</span>
</code></pre></div>


<p>ここでは、CUDAとOpenMPI、MVAPICH、CMakeの設定をしています。
例えば、<code>cuda@abci-8.0.61.2: /apps/cuda/8.0.61.2</code>では、SpackでCUDAのバージョンabci-8.0.61.2のインストールを実行すると、実際にはインストールはせずに、<code>/apps/cuda/8.0.61.2</code>としてインストールされているものを使用することを意味します。
CUDAセクションでのみ記述されている<code>buildable: False</code>は、Spackにここで指定しているバージョン以外のCUDAをインストールさせないことを意味しています。
ABCIが提供していないバージョンのCUDAをSpackでインストールしたい場合は、この記述を削除してください。</p>
<p><code>packages.yaml</code>ファイルの設定の詳細は<a href="https://spack.readthedocs.io/en/latest/build_settings.html">公式ドキュメント</a>を参照ください。</p>
<h2 id="basic-of-spack">Spack 基本操作</h2>
<p>Spackの基本操作についてまとめます。
詳細は<a href="https://spack.readthedocs.io/en/latest/basic_usage.html">公式ドキュメント</a>を参照ください。</p>
<h3 id="compiler-operations">コンパイラ関連</h3>
<p>Spackに登録されているコンパイラ一覧は<code>compiler list</code>サブコマンドで確認できます。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">es1</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">compiler</span> <span class="n">list</span>
<span class="o">==&gt;</span> <span class="n">Available</span> <span class="n">compilers</span>
<span class="o">--</span> <span class="n">gcc</span> <span class="n">centos7</span><span class="o">-</span><span class="n">x86_64</span> <span class="o">-------------------------------------------</span>
<span class="n">gcc</span><span class="mf">@7.4.0</span>  <span class="n">gcc</span><span class="mf">@4.8.5</span>  <span class="n">gcc</span><span class="mf">@4.4.7</span>
</code></pre></div>


<p>特定コンパイラの詳細情報を確認するには、<code>compiler info</code>サブコマンドを実行します。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">es1</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">compiler</span> <span class="n">info</span> <span class="n">gcc</span><span class="mf">@4.8.5</span>
<span class="n">gcc</span><span class="mf">@4.8.5</span><span class="o">:</span>
    <span class="nl">paths</span><span class="p">:</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">gcc</span>
        <span class="n">cxx</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">g</span><span class="o">++</span>
        <span class="n">f77</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">gfortran</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">gfortran</span>
    <span class="n">modules</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">operating</span> <span class="n">system</span>  <span class="o">=</span> <span class="n">centos7</span>
</code></pre></div>


<h3 id="software-management-operations">ソフトウェア管理関連</h3>
<h4 id="install">インストール</h4>
<p>OpenMPIのSpack標準バージョンは、以下の通りにインストールできます。
<code>schedulers=sge</code>と<code>fabrics=auto</code>の意味は<a href="#cuda-aware-openmpi">導入事例</a>を参照ください。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack install openmpi schedulers=sge fabrics=auto</span>
</code></pre></div>


<p>バージョンを指定する場合は、<code>@</code>で指定します。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">es1</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">install</span> <span class="n">openmpi</span><span class="mf">@3.1.4</span> <span class="n">schedulers</span><span class="o">=</span><span class="n">sge</span> <span class="n">fabrics</span><span class="o">=</span><span class="k">auto</span>
</code></pre></div>


<p>コンパイラを指定する場合は<code>%</code>で指定します。
以下の例では、コンパイラのバージョンも指定しています。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">es1</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">install</span> <span class="n">openmpi</span><span class="mf">@3.1.4</span> <span class="o">%</span><span class="n">gcc</span><span class="mf">@7.4.0</span> <span class="n">schedulers</span><span class="o">=</span><span class="n">sge</span> <span class="n">fabrics</span><span class="o">=</span><span class="k">auto</span>
</code></pre></div>


<h4 id="uninstall">アンインストール</h4>
<p><code>uninstall</code>サブコマンドで、インストール済みのソフトウェアをアンインストールできます。
インストール同様に、バージョンを指定してアンインストールできます。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack uninstall openmpi</span>
</code></pre></div>


<p>ソフトウェアのハッシュを指定してアンインストールすることもできます。
<code>/</code>に続いてハッシュを指定します。
ハッシュは<a href="#information">情報確認</a>に示す通り、<code>find</code>サブコマンドで取得できます。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack uninstall /ffwtsvk</span>
</code></pre></div>


<p>インストールした全てのソフトウェアを一括して削除するには以下の通りに実行します。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack uninstall --all</span>
</code></pre></div>


<h4 id="information">情報確認</h4>
<p>Spackでインストールできるソフトウェア一覧は、<code>list</code>サブコマンドで確認できます。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack list</span>
<span class="err">abinit</span>
<span class="err">abyss</span>
<span class="err">(snip)</span>
</code></pre></div>


<p>キーワードを指定することで、キーワードを名前の一部に含むソフトウェアのみを表示できます。
以下では<code>mpi</code>をキーワードとして指定しています。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack list mpi</span>
<span class="err">==&gt; 21 packages.</span>
<span class="err">compiz       mpifileutils  mpix-launch-swift  r-rmpi        vampirtrace</span>
<span class="err">fujitsu-mpi  mpilander     openmpi            rempi</span>
<span class="err">intel-mpi    mpileaks      pbmpi              spectrum-mpi</span>
<span class="err">mpibash      mpip          pnmpi              sst-dumpi</span>
<span class="err">mpich        mpir          py-mpi4py          umpire</span>
</code></pre></div>


<p>インストールしたソフトウェア一覧は<code>find</code>サブコマンドで確認できます。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">es1</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">find</span>
<span class="o">==&gt;</span> <span class="mi">49</span> <span class="n">installed</span> <span class="n">packages</span>
<span class="o">--</span> <span class="n">linux</span><span class="o">-</span><span class="n">centos7</span><span class="o">-</span><span class="n">haswell</span> <span class="o">/</span> <span class="n">gcc</span><span class="mf">@4.8.5</span> <span class="o">----------------------------</span>
<span class="n">autoconf</span><span class="mf">@2.69</span>    <span class="n">gdbm</span><span class="mf">@1.18.1</span>          <span class="n">libxml2</span><span class="mf">@2.9.9</span>  <span class="n">readline</span><span class="mf">@8.0</span>
<span class="p">(</span><span class="n">snip</span><span class="p">)</span>
</code></pre></div>


<p>インストールしたソフトウェアのハッシュ、依存関係は<code>find</code>サブコマンドに<code>-dl</code>オプションを指定することで確認できます。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">es1</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">find</span> <span class="o">-</span><span class="n">dl</span> <span class="n">openmpi</span>
<span class="o">--</span> <span class="n">linux</span><span class="o">-</span><span class="n">centos7</span><span class="o">-</span><span class="n">skylake_avx512</span> <span class="o">/</span> <span class="n">gcc</span><span class="mf">@7.4.0</span> <span class="o">---------------------</span>
<span class="n">sif5fzv</span> <span class="n">openmpi</span><span class="mf">@3.1.4</span>
<span class="n">xqsp4xn</span>     <span class="n">hwloc</span><span class="mf">@1.11.11</span>
<span class="mi">3</span><span class="n">movoj3</span>         <span class="n">libpciaccess</span><span class="mf">@0.13.5</span>
<span class="n">d6xghgt</span>         <span class="n">libxml2</span><span class="mf">@2.9.9</span>
<span class="n">zydtv5a</span>             <span class="n">libiconv</span><span class="mf">@1.16</span>
<span class="n">y6e4zi2</span>             <span class="n">xz</span><span class="mf">@5.2.4</span>
<span class="n">kv37bl2</span>             <span class="n">zlib</span><span class="mf">@1.2.11</span>
<span class="n">onnjyv2</span>         <span class="n">numactl</span><span class="mf">@2.0.12</span>
</code></pre></div>


<p>特定のソフトウェアの詳細情報を確認するには、<code>info</code>サブコマンドを使用します。</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">username@es1 ~</span><span class="o">]</span><span class="err">$</span><span class="w"> </span><span class="n">spack</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="n">openmpi</span><span class="w"></span>
<span class="nl">AutotoolsPackage</span><span class="p">:</span><span class="w">   </span><span class="n">openmpi</span><span class="w"></span>

<span class="nl">Description</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="n">An</span><span class="w"> </span><span class="k">open</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Passing</span><span class="w"> </span><span class="n">Interface</span><span class="w"> </span><span class="n">implementation</span><span class="p">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="k">Open</span><span class="w"> </span><span class="n">MPI</span><span class="w"></span>
<span class="w">    </span><span class="n">Project</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="k">open</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Passing</span><span class="w"> </span><span class="n">Interface</span><span class="w"> </span><span class="n">implementation</span><span class="w"> </span><span class="n">that</span><span class="w"></span>
<span class="p">(</span><span class="n">snip</span><span class="p">)</span><span class="w"></span>
</code></pre></div>


<p>特定ソフトウェアの、インストール可能なバージョン一覧は<code>versions</code>サブコマンドで確認できます。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack versions openmpi</span>
<span class="err">==&gt; Safe versions (already checksummed):</span>
<span class="err">  develop  3.0.3  2.1.1   1.10.5  1.8.5  1.7.2  1.5.5  1.4.2  1.2.8  1.1.5</span>
<span class="err">  4.0.1    3.0.2  2.1.0   1.10.4  1.8.4  1.7.1  1.5.4  1.4.1  1.2.7  1.1.4</span>
<span class="err">  4.0.0    3.0.1  2.0.4   1.10.3  1.8.3  1.7    1.5.3  1.4    1.2.6  1.1.3</span>
<span class="err">  3.1.4    3.0.0  2.0.3   1.10.2  1.8.2  1.6.5  1.5.2  1.3.4  1.2.5  1.1.2</span>
<span class="err">  3.1.3    2.1.6  2.0.2   1.10.1  1.8.1  1.6.4  1.5.1  1.3.3  1.2.4  1.1.1</span>
<span class="err">  3.1.2    2.1.5  2.0.1   1.10.0  1.8    1.6.3  1.5    1.3.2  1.2.3  1.1</span>
<span class="err">  3.1.1    2.1.4  2.0.0   1.8.8   1.7.5  1.6.2  1.4.5  1.3.1  1.2.2  1.0.2</span>
<span class="err">  3.1.0    2.1.3  1.10.7  1.8.7   1.7.4  1.6.1  1.4.4  1.3    1.2.1  1.0.1</span>
<span class="err">  3.0.4    2.1.2  1.10.6  1.8.6   1.7.3  1.6    1.4.3  1.2.9  1.2    1.0</span>
</code></pre></div>


<h3 id="use-of-installed-software">ソフトウェア利用方法</h3>
<p>SpackでインストールしたソフトウェアはEnvironment Modulesに自動的に登録されます。
ABCIが提供するモジュール同様に、ロードして使用できます。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ module load xxxxx</span>
</code></pre></div>


<p>インストールした全ソフトウェアのモジュールを更新するには、次のコマンドを実行します。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack module tcl refresh</span>
</code></pre></div>


<p>インストールしたソフトウェアのモジュールを削除するには、次のコマンドを実行します。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack module tcl rm</span>
</code></pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ソフトウェアをインストールしてもモジュールに登録されない場合は、Spackの環境設定スクリプトの読み込みを行ってみてください。</p>
<p><code>[username@es1 ~]$ source ${HOME}/spack/share/spack/setup-env.sh</code></p>
</div>
<h2 id="example-software-installation">ソフトウェア導入事例</h2>
<h3 id="cuda-aware-openmpi">CUDA-aware OpenMPI</h3>
<p>ABCIでは、CUDA-aware OpenMPIをモジュールで提供していますが、全てのコンパイラ、CUDA、OpenMPIの組み合わせで提供しているわけではありません（<a href="https://docs.abci.ai/ja/08/#open-mpi">参考</a>）。
使用したい組み合わせがモジュール提供されていない場合は、Spackでインストールするのが簡単です。</p>
<h4 id="how-to-install">インストール方法</h4>
<p>CUDA 10.1.243を使用するOpenMPI 3.1.1をインストールする場合の例です。
GPUを搭載する計算ノード上で作業を行います。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">g0001</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">install</span> <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">10.1.243</span>
<span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">g0001</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">install</span> <span class="n">openmpi</span><span class="mf">@3.1.1</span> <span class="o">+</span><span class="n">cuda</span> <span class="n">schedulers</span><span class="o">=</span><span class="n">sge</span> <span class="n">fabrics</span><span class="o">=</span><span class="k">auto</span> <span class="o">^</span><span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">10.1.243</span>
<span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">g0001</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">find</span> <span class="o">--</span><span class="n">paths</span> <span class="n">openmpi</span><span class="mf">@3.1.1</span>
<span class="o">==&gt;</span> <span class="mi">1</span> <span class="n">installed</span> <span class="n">package</span>
<span class="o">--</span> <span class="n">linux</span><span class="o">-</span><span class="n">centos7</span><span class="o">-</span><span class="n">haswell</span> <span class="o">/</span> <span class="n">gcc</span><span class="mf">@4.8.5</span> <span class="o">----------------------------</span>
<span class="n">openmpi</span><span class="mf">@3.1.1</span>  <span class="err">$</span><span class="p">{</span><span class="n">SPACK_ROOT</span><span class="p">}</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">spack</span><span class="o">/</span><span class="n">linux</span><span class="o">-</span><span class="n">centos7</span><span class="o">-</span><span class="n">haswell</span><span class="o">/</span><span class="n">gcc</span><span class="o">-</span><span class="mf">4.8.5</span><span class="o">/</span><span class="n">openmpi</span><span class="o">-</span><span class="mf">3.1.1</span><span class="o">-</span><span class="mi">4</span><span class="n">mmghhfuk5n7my7g3ko2zwzlo4wmoc5v</span>
<span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">g0001</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">echo</span> <span class="s">&quot;btl_openib_warn_default_gid_prefix = 0&quot;</span> <span class="o">&gt;&gt;</span> <span class="err">$</span><span class="p">{</span><span class="n">SPACK_ROOT</span><span class="p">}</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">spack</span><span class="o">/</span><span class="n">linux</span><span class="o">-</span><span class="n">centos7</span><span class="o">-</span><span class="n">haswell</span><span class="o">/</span><span class="n">gcc</span><span class="o">-</span><span class="mf">4.8.5</span><span class="o">/</span><span class="n">openmpi</span><span class="o">-</span><span class="mf">3.1.1</span><span class="o">-</span><span class="mi">4</span><span class="n">mmghhfuk5n7my7g3ko2zwzlo4wmoc5v</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openmpi</span><span class="o">-</span><span class="n">mca</span><span class="o">-</span><span class="n">params</span><span class="p">.</span><span class="n">conf</span>
</code></pre></div>


<p>1行目では、ABCIが提供するCUDAを使用するよう、CUDAのバージョン<code>abci-10.1.243</code>をインストールします。
2行目では、<a href="https://docs.abci.ai/ja/appendix1/#open-mpi">このページ</a>と同様の設定で、OpenMPIをインストールしています。
インストールオプションの意味は以下の通りです。</p>
<ul>
<li><code>+cuda</code>: CUDAを有効にしてビルドします。</li>
<li><code>schedulers=sge</code>: MPIプロセスを起動する手段を指定しています。ABCIではSGE互換のUGEを使っているため、sgeを指定します。</li>
<li><code>fabrics=auto</code>: 通信ライブラリを選択します。この例では自動判別としています。</li>
<li><code>^cuda@abci-10.1.243</code>: 使用するCUDAを指定します。<code>^</code>は依存するソフトウェアを指定するときに使います。</li>
</ul>
<p>4行目では実行時の警告を消すため、設定ファイルを編集しています（任意）。
そのため、3行目でOpenMPIがインストールされたパスを確認しています。</p>
<p>Spackでは、同一ソフトウェアを異なる設定で複数インストールし、管理することができます。
ここでは、CUDA 9.0.176.4を使用するOpenMPI 3.1.1を追加インストールします。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">g0001</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">install</span> <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">9.0.176.4</span>
<span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">g0001</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">install</span> <span class="n">openmpi</span><span class="mf">@3.1.1</span> <span class="o">+</span><span class="n">cuda</span> <span class="n">schedulers</span><span class="o">=</span><span class="n">sge</span> <span class="n">fabrics</span><span class="o">=</span><span class="k">auto</span> <span class="o">^</span><span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">9.0.176.4</span>
</code></pre></div>


<h4 id="how-to-use">使い方</h4>
<p>「CUDA 10.1.243を使用するOpenMPI 3.1.1」を使う場合の利用方法を説明します。</p>
<p>2種類のOpenMPI 3.1.1がインストールされていますので、次のようにモジュールが見えます。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ module avail openmpi</span>
<span class="err">------------------------- $HOME/spack/share/spack/modules/linux-centos7-haswell -------------------------</span>
<span class="err">openmpi-3.1.1-gcc-4.8.5-4mmghhf             openmpi-3.1.1-gcc-4.8.5-zqwwrqy</span>
<span class="err">(snip)</span>
</code></pre></div>


<p>まず、使用するOpenMPIのモジュールを判別します。
Spackにより生成されるモジュールは、(1)ソフトウェア名、(2)ソフトウェアバージョン、(3)コンパイラ、(4)コンパイラバージョン、(5)ハッシュ、による名前が付けられています。
今回は(1) ~ (4)が等しいため、(5)のハッシュで判別する必要があります。</p>
<p>OpenMPIの依存関係を確認し、CUDA 10.1.243を使用しているOpenMPIのハッシュを取得します。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">es1</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">find</span> <span class="o">-</span><span class="n">dl</span> <span class="n">openmpi</span>
<span class="o">==&gt;</span> <span class="mi">2</span> <span class="n">installed</span> <span class="n">packages</span>
<span class="o">--</span> <span class="n">linux</span><span class="o">-</span><span class="n">centos7</span><span class="o">-</span><span class="n">haswell</span> <span class="o">/</span> <span class="n">gcc</span><span class="mf">@4.8.5</span> <span class="o">----------------------------</span>
<span class="mi">4</span><span class="n">mmghhf</span> <span class="n">openmpi</span><span class="mf">@3.1.1</span>
<span class="n">glgpfmf</span>     <span class="n">hwloc</span><span class="mf">@1.11.11</span>
<span class="mi">6</span><span class="n">ddc273</span>         <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">10.1.243</span>
<span class="p">(</span><span class="n">snip</span><span class="p">)</span>

<span class="n">zqwwrqy</span> <span class="n">openmpi</span><span class="mf">@3.1.1</span>
<span class="n">b4gs3k5</span>     <span class="n">hwloc</span><span class="mf">@1.11.11</span>
<span class="n">l6ayrkp</span>         <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">9.0.176.4</span>
<span class="p">(</span><span class="n">snip</span><span class="p">)</span>
</code></pre></div>


<p>ハッシュ<code>4mmghhf</code>を持つOpenMPIが使用したいOpenMPIですので、モジュール<code>openmpi-3.1.1-gcc-4.8.5-4mmghhf</code>を使用すれば良いとわかります。</p>
<p>計算ノード上でプログラムをコンパイルする場合は、ABCIが提供するCUDAモジュールとインストールしたOpenMPIのモジュールを読み込みます。</p>
<div class="codehilite"><pre><span></span><code>source <span class="cp">${</span><span class="n">HOME</span><span class="cp">}</span>/spack/share/spack/setup-env.sh
[username@g0001 ~]$ module load cuda/10.1/10.1.243
[username@g0001 ~]$ module load openmpi-3.1.1-gcc-4.8.5-4mmghhf
[username@g0001 ~]$ mpicc ...
</code></pre></div>


<p>ジョブスクリプトでは、以下のように使用します。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#$-l rt_F=2</span>
<span class="c1">#$-j y</span>
<span class="c1">#$-cwd</span>

<span class="nb">source</span> /etc/profile.d/modules.sh
<span class="nb">source</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/spack/share/spack/setup-env.sh
module load cuda/10.1/10.1.243
module load openmpi-3.1.1-gcc-4.8.5-4mmghhf

<span class="nv">NUM_NODES</span><span class="o">=</span><span class="si">${</span><span class="nv">NHOSTS</span><span class="si">}</span>
<span class="nv">NUM_GPUS_PER_NODE</span><span class="o">=</span><span class="m">4</span>
<span class="nv">NUM_PROCS</span><span class="o">=</span><span class="k">$(</span>expr <span class="si">${</span><span class="nv">NUM_NODES</span><span class="si">}</span> <span class="se">\*</span> <span class="si">${</span><span class="nv">NUM_GPUS_PER_NODE</span><span class="si">}</span><span class="k">)</span>
<span class="nv">MPIOPTS</span><span class="o">=</span><span class="s2">&quot;-n </span><span class="si">${</span><span class="nv">NUM_PROCS</span><span class="si">}</span><span class="s2"> -map-by ppr:</span><span class="si">${</span><span class="nv">NUM_GPUS_PER_NODE</span><span class="si">}</span><span class="s2">:node -x PATH -x LD_LIBRARY_PATH&quot;</span>
mpiexec <span class="si">${</span><span class="nv">MPIOPTS</span><span class="si">}</span> YOUR_PROGRAM
</code></pre></div>
</td></tr></table>

<p>不要になった場合は、ハッシュを指定してアンインストールします。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack uninstall /4mmghhf</span>
</code></pre></div>


<h3 id="cuda-aware-mvapich2">CUDA-aware MVAPICH2</h3>
<p>ABCIが提供するMVAPICH2モジュールはCUDA対応していません。
CUDA-aware MVAPICH2を使用する場合は、以下を参考にSpackでインストールしてください。</p>
<p>GPUを搭載する計算ノード上で作業を行います。
<a href="#cuda-aware-openmpi">OpenMPIと同様</a>に、使用するCUDAをインストールしたのちに、CUDAオプション（<code>+cuda</code>）、通信ライブラリ（<code>fabrics=mrail</code>）、およびCUDAの依存関係（<code>^cuda@abci-10.1.243</code>）を指定してMVAPICH2をインストールします。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">g0001</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">install</span> <span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">10.1.243</span>
<span class="p">[</span><span class="n">username</span><span class="p">@</span><span class="n">g0001</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">spack</span> <span class="n">install</span> <span class="n">mvapich2</span><span class="mf">@2.3</span> <span class="o">+</span><span class="n">cuda</span> <span class="n">fabrics</span><span class="o">=</span><span class="n">mrail</span> <span class="o">^</span><span class="n">cuda</span><span class="p">@</span><span class="n">abci</span><span class="o">-</span><span class="mf">10.1.243</span>
</code></pre></div>


<p>使い方もOpenMPIと同様に、CUDAとインストールしたMVAPICH2をロードして使います。
以下にジョブスクリプト例を示します。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#$-l rt_F=2</span>
<span class="c1">#$-j y</span>
<span class="c1">#$-cwd</span>

<span class="nb">source</span> /etc/profile.d/modules.sh
<span class="nb">source</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/spack/share/spack/setup-env.sh
module load cuda/10.1/10.1.243
module load mvapich2-2.3-gcc-4.8.5-wy2qkke

<span class="nv">NUM_NODES</span><span class="o">=</span><span class="si">${</span><span class="nv">NHOSTS</span><span class="si">}</span>
<span class="nv">NUM_GPUS_PER_NODE</span><span class="o">=</span><span class="m">4</span>
<span class="nv">NUM_PROCS</span><span class="o">=</span><span class="k">$(</span>expr <span class="si">${</span><span class="nv">NUM_NODES</span><span class="si">}</span> <span class="se">\*</span> <span class="si">${</span><span class="nv">NUM_GPUS_PER_NODE</span><span class="si">}</span><span class="k">)</span>
<span class="nv">MPIE_ARGS</span><span class="o">=</span><span class="s2">&quot;-genv MV2_USE_CUDA=1&quot;</span>
<span class="nv">MPIOPTS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MPIE_ARGS</span><span class="si">}</span><span class="s2"> -np </span><span class="si">${</span><span class="nv">NUM_PROCS</span><span class="si">}</span><span class="s2"> -ppn </span><span class="si">${</span><span class="nv">NUM_GPUS_PER_NODE</span><span class="si">}</span><span class="s2">&quot;</span>

mpiexec <span class="si">${</span><span class="nv">MPIOPTS</span><span class="si">}</span> YOUR_PROGRAM
</code></pre></div>
</td></tr></table>

<h3 id="mpifileutils">MPIFileUtils</h3>
<p><a href="https://hpc.github.io/mpifileutils/">MPIFileUtils</a>は、MPIを用いたファイル転送ツールです。
複数のライブラリに依存するため、マニュアルでインストールするのは面倒ですが、Spackを用いると簡単にインストールできます。</p>
<p>以下の例では、ABCIがモジュール提供するOpenMPI 2.1.6を使用して、MPIFileUtilsをインストールします。
該当するOpenMPIをインストールした後で（1行目）、それへの依存を指定してMPIFileUtilsをインストールします（2行目）。</p>
<div class="codehilite"><pre><span></span><code><span class="err">[username@es1 ~]$ spack install openmpi@abci-2.1.6-nocuda</span>
<span class="err">[username@es1 ~]$ spack install mpifileutils ^openmpi@abci-2.1.6-nocuda</span>
</code></pre></div>


<p>使うときには、OpenMPI 2.1.6とMPIFileUtilsのモジュールをロードします。
MPIFileUtilsのモジュールをロードすると、<code>dbcast</code>などのプログラムへのパスがセットされます。
以下にジョブスクリプト例を示します。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#$-l rt_F=2</span>
<span class="c1">#$-j y</span>
<span class="c1">#$-cwd</span>

<span class="nb">source</span> /etc/profile.d/modules.sh
<span class="nb">source</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/spack/share/spack/setup-env.sh
module load openmpi/2.1.6
module load mpifileutils-0.9.1-gcc-4.8.5-qdv7523

<span class="nv">NPPN</span><span class="o">=</span><span class="m">5</span>
<span class="nv">NMPIPROC</span><span class="o">=</span><span class="k">$((</span> <span class="nv">$NHOSTS</span> <span class="o">*</span> <span class="nv">$NPPN</span> <span class="k">))</span>
<span class="nv">SRC_FILE</span><span class="o">=</span>name_of_file
<span class="nv">DST_FILE</span><span class="o">=</span>name_of_file

mpiexec -n <span class="si">${</span><span class="nv">NMPIPROC</span><span class="si">}</span> -map-by ppr:<span class="si">${</span><span class="nv">NPPN</span><span class="si">}</span>:node dbcast <span class="nv">$SRC_FILE</span> <span class="nv">$DST_FILE</span>
</code></pre></div>
</td></tr></table></article></div></div></main><footer class="md-footer"><div class="md-footer-nav"><nav class="md-footer-nav__inner md-grid"><a href="../sregistry-cli/" title="Singularity Global Clientの利用" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev"><div class="md-flex__cell md-flex__cell--shrink"><i class="md-icon md-icon--arrow-back md-footer-nav__button"></i></div><div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span class="md-flex__ellipsis"><span class="md-footer-nav__direction">前</span>Singularity Global Clientの利用</span></div></a><a href="../datasets/" title="データセットの利用" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next"><div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span class="md-flex__ellipsis"><span class="md-footer-nav__direction">次</span>データセットの利用</span></div><div class="md-flex__cell md-flex__cell--shrink"><i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i></div></a></nav></div><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class="md-footer-copyright"><div class="md-footer-copyright__highlight">Copyright &copy; 2018 National Institute of Advanced Industrial Science and Technology (AIST)</div>powered by <a href="https://www.mkdocs.org">MkDocs</a> and <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a></div></div></div></footer></div><script src="../../assets/javascripts/application.b260a35d.js"></script><script src="../../assets/javascripts/lunr/lunr.stemmer.support.js"></script><script src="../../assets/javascripts/lunr/tinyseg.js"></script><script src="../../assets/javascripts/lunr/lunr.ja.js"></script><script>app.initialize({version:"1.1.2",url:{base:"../.."}})</script></body></html>