



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="ABCI User Guide, English version">
      
      
        <link rel="canonical" href="https://docs.abci.ai/en/tips/spack/">
      
      
        <meta name="author" content="AIST">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.6.3">
    
    
      
        <title>Spack - ABCI User Guide</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#ef5350">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-118371652-2", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="red" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#software-management-by-spack" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://docs.abci.ai/en/" title="ABCI User Guide" aria-label="ABCI User Guide" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../../img/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              ABCI User Guide
            </span>
            <span class="md-header-nav__topic">
              
                Spack
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/aistairc/abci-docs/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://docs.abci.ai/en/" title="ABCI User Guide" class="md-nav__button md-logo">
      
        <img alt="logo" src="../../img/logo.png" width="48" height="48">
      
    </a>
    ABCI User Guide
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aistairc/abci-docs/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      User Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../01/" title="1. ABCI System Overview" class="md-nav__link">
      1. ABCI System Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../02/" title="2. ABCI System User Environment" class="md-nav__link">
      2. ABCI System User Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../03/" title="3. Job Execution Environment" class="md-nav__link">
      3. Job Execution Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../04/" title="4. Storage" class="md-nav__link">
      4. Storage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../05/" title="5. Environment Modules" class="md-nav__link">
      5. Environment Modules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../06/" title="6. Python" class="md-nav__link">
      6. Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../07/" title="7. GPU" class="md-nav__link">
      7. GPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../08/" title="8. MPI" class="md-nav__link">
      8. MPI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../09/" title="9. Linux Containers" class="md-nav__link">
      9. Linux Containers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../10/" title="10. Software Development Environment" class="md-nav__link">
      10. Software Development Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendix/installed-software/" title="Appendix. Configuration of Installed Software" class="md-nav__link">
      Appendix. Configuration of Installed Software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendix/using-abci-with-hpci/" title="Appendix. Using ABCI with HPCI" class="md-nav__link">
      Appendix. Using ABCI with HPCI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendix/external-networks/" title="Appendix. Communications with External Networks" class="md-nav__link">
      Appendix. Communications with External Networks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendix/ssh-access/" title="Appendix. SSH Access to Compute Nodes" class="md-nav__link">
      Appendix. SSH Access to Compute Nodes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Applications
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Applications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../apps/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../apps/tensorflow/" title="TensorFlow" class="md-nav__link">
      TensorFlow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../apps/tensorflow-keras/" title="TensorFlow Keras" class="md-nav__link">
      TensorFlow Keras
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../apps/pytorch/" title="PyTorch" class="md-nav__link">
      PyTorch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../apps/mxnet/" title="MXNet" class="md-nav__link">
      MXNet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../apps/chainer/" title="Chainer" class="md-nav__link">
      Chainer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../apps/others/" title="Others" class="md-nav__link">
      Others
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Tips
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Tips
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../ngc/" title="NVIDIA NGC" class="md-nav__link">
      NVIDIA NGC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../remote-desktop/" title="Remote Desktop" class="md-nav__link">
      Remote Desktop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../awscli/" title="AWS CLI" class="md-nav__link">
      AWS CLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../putty/" title="PuTTY" class="md-nav__link">
      PuTTY
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../jupyter-notebook/" title="Jupyter Notebook" class="md-nav__link">
      Jupyter Notebook
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../sregistry-cli/" title="Singularity Global Client" class="md-nav__link">
      Singularity Global Client
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Spack
      </label>
    
    <a href="./" title="Spack" class="md-nav__link md-nav__link--active">
      Spack
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup-spack" class="md-nav__link">
    Setup Spack
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install" class="md-nav__link">
    Install
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-abci" class="md-nav__link">
    Configuration for ABCI
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-compilers" class="md-nav__link">
    Adding Compilers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-abci-software" class="md-nav__link">
    Adding ABCI Software
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-of-spack" class="md-nav__link">
    Basic of Spack
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compiler-operations" class="md-nav__link">
    Compiler Operations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software-management-operations" class="md-nav__link">
    Software Management Operations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install" class="md-nav__link">
    Install
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uninstall" class="md-nav__link">
    Uninstall
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#information" class="md-nav__link">
    Information
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-of-installed-software" class="md-nav__link">
    Use of Installed Software
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-environments" class="md-nav__link">
    Using Environments
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-of-use" class="md-nav__link">
    Example of Use
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cuda-aware-openmpi" class="md-nav__link">
    CUDA-aware OpenMPI
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-install" class="md-nav__link">
    How to Install
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-use" class="md-nav__link">
    How to Use
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuda-aware-mvapich2" class="md-nav__link">
    CUDA-aware MVAPICH2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mpifileutils" class="md-nav__link">
    MPIFileUtils
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-singularity-image-from-environment" class="md-nav__link">
    Build Singularity Image from Environment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../datasets/" title="Datasets" class="md-nav__link">
      Datasets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../dl-amazon-ecr/" title="Amazon ECR" class="md-nav__link">
      Amazon ECR
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      ABCI Cloud Storage
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        ABCI Cloud Storage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../abci-cloudstorage/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../abci-cloudstorage/cs-account/" title="Accounts and Access keys" class="md-nav__link">
      Accounts and Access keys
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../abci-cloudstorage/usage/" title="Usage" class="md-nav__link">
      Usage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../abci-cloudstorage/encryption/" title="Data encryption" class="md-nav__link">
      Data encryption
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../abci-cloudstorage/acl/" title="Access Control (1)" class="md-nav__link">
      Access Control (1) 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../abci-cloudstorage/policy/" title="Access Control (2)" class="md-nav__link">
      Access Control (2) 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../abci-cloudstorage/publishing-datasets/" title="Publishing Datasets" class="md-nav__link">
      Publishing Datasets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../abci-cloudstorage/caution/" title="Caution" class="md-nav__link">
      Caution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../abci-datasets/" title="ABCI Datasets" class="md-nav__link">
      ABCI Datasets
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../abci-singularity-endpoint/" title="ABCI Singularity Endpoint" class="md-nav__link">
      ABCI Singularity Endpoint
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../known-issues/" title="Known Issues" class="md-nav__link">
      Known Issues
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../system-updates/" title="System Updates" class="md-nav__link">
      System Updates
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://abci.ai/en/about_abci/info.html" title="Operation Status" class="md-nav__link">
      Operation Status
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contact/" title="Contact" class="md-nav__link">
      Contact
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      Links
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        Links
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://abci.ai/" title="ABCI Web page" class="md-nav__link">
      ABCI Web page
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://docs.abci.ai/portal/en/" title="ABCI User Portal Guide" class="md-nav__link">
      ABCI User Portal Guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://portal.abci.ai/user/project_register_app.php?lang=en" title="ABCI User Portal (Registration)" class="md-nav__link">
      ABCI User Portal (Registration)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://portal.abci.ai/user/login.php?lang=en" title="ABCI User Portal (Login)" class="md-nav__link">
      ABCI User Portal (Login)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://docs.abci.ai/ja/" title="Japanese version" class="md-nav__link">
      Japanese version
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup-spack" class="md-nav__link">
    Setup Spack
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install" class="md-nav__link">
    Install
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-abci" class="md-nav__link">
    Configuration for ABCI
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-compilers" class="md-nav__link">
    Adding Compilers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-abci-software" class="md-nav__link">
    Adding ABCI Software
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-of-spack" class="md-nav__link">
    Basic of Spack
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compiler-operations" class="md-nav__link">
    Compiler Operations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software-management-operations" class="md-nav__link">
    Software Management Operations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install" class="md-nav__link">
    Install
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uninstall" class="md-nav__link">
    Uninstall
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#information" class="md-nav__link">
    Information
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-of-installed-software" class="md-nav__link">
    Use of Installed Software
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-environments" class="md-nav__link">
    Using Environments
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-of-use" class="md-nav__link">
    Example of Use
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cuda-aware-openmpi" class="md-nav__link">
    CUDA-aware OpenMPI
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-install" class="md-nav__link">
    How to Install
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-use" class="md-nav__link">
    How to Use
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuda-aware-mvapich2" class="md-nav__link">
    CUDA-aware MVAPICH2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mpifileutils" class="md-nav__link">
    MPIFileUtils
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-singularity-image-from-environment" class="md-nav__link">
    Build Singularity Image from Environment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aistairc/abci-docs/edit/master/en/docs/tips/spack.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="software-management-by-spack">Software Management by Spack</h1>
<p><a href="https://spack.io/">Spack</a> is a software package manager for supercomputers developed by Lawrence Livermore National Laboratory.
By using Spack, you can easily install software packages by changing their versions, configurations and compilers, and then select necessary one them when you use.
Using Spack on ABCI enables easily installing software which is not officially supported by ABCI.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We tested Spack using bash on Dec 3rd 2020, and we used Spack 0.16.0 which was the latest version at that time.</p>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Spack installs software packaged in its original format which is not compatible with packages
provided by any Linux distributions, such as <code>.deb</code> and <code>.rpm</code>.
Therefore, Spack is not a replacement of <code>yum</code> or <code>apt</code> system.</p>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Spack installs software under a directory where Spack was installed.
Manage software installed by Sapck by yourself, for example, by uninstalling unused software, because Spack consumes large amount of disk space if you install many software.</p>
</div>
<h2 id="setup-spack">Setup Spack</h2>
<h3 id="install">Install</h3>
<p>You can install Spack by cloning from GitHub and checking out the version you want to use.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>git clone https://github.com/spack/spack.git
<span class="gp">[username@es1 ~]$ </span><span class="nb">cd</span> ./spack
<span class="gp">[username@es1 ~/spack]$ </span>git checkout v0.16.0
</code></pre></div>

<p>After that, you can use Spack by loading a setup shell script.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span><span class="nb">source</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/spack/share/spack/setup-env.sh
</code></pre></div>

<h3 id="configuration-for-abci">Configuration for ABCI</h3>
<h4 id="adding-compilers">Adding Compilers</h4>
<p>First, you have to register compilers you want to use in Spack.</p>
<p><code>spack compiler list</code> command automatically detects and registers compilers which are located in the default path (/usr/bin).</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack compiler list
<span class="go">==&gt; Available compilers</span>
<span class="go">-- gcc centos7-x86_64 -------------------------------------------</span>
<span class="go">gcc@4.8.5  gcc@4.4.7</span>
</code></pre></div>

<p>ABCI provides a pre-configured compiler definition file for Spack, <code>compilers.yaml</code>.
Copying this file to your environment sets up GCC 4.8.5 and 7.4.0 to be used in Spack.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>cp /apps/spack/compilers.yaml <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.spack/linux/
<span class="gp">[username@es1 ~]$ </span>spack compiler list
<span class="go">==&gt; Available compilers</span>
<span class="go">-- gcc centos7-x86_64 -------------------------------------------</span>
<span class="go">gcc@7.4.0  gcc@4.8.5</span>
</code></pre></div>

<h4 id="adding-abci-software">Adding ABCI Software</h4>
<p>Spack automatically resolves software dependencies and installs dependant software.
Spack, by default, installs another copies of software which is already supported by ABCI, such as CUDA and OpenMPI.
As it is a waste of disk space, we recommend to configure Spack to <em>refer to</em> software supported by ABCI.</p>
<p>Software referred by Spack can be defined in the configuration file <code>$HOME/.spack/linux/packages.yaml</code>.
ABCI provides a pre-configured <code>packages.yaml</code> which defines mappings of Spack package and software installed on ABCI.
Copying this file to your environment lets Spack use installed CUDA, OpenMPI, MVAPICH, cmake and etc.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>cp /apps/spack/packages.yaml <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.spack/linux/
</code></pre></div>

<p>packages.yaml (excerpt)</p>
<div class="codehilite"><pre><span></span><code><span class="nt">packages</span><span class="p">:</span>
  <span class="nt">cuda</span><span class="p">:</span>
    <span class="nt">buildable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
    <span class="nt">externals</span><span class="p">:</span>
<span class="l l-Scalar l-Scalar-Plain">(snip)</span>
    <span class="l l-Scalar l-Scalar-Plain">- spec</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cuda@10.2.89%gcc@4.8.5</span>
      <span class="l l-Scalar l-Scalar-Plain">modules</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cuda/10.2/10.2.89</span>
<span class=" -Error">    </span><span class="p p-Indicator">-</span> <span class="nt">spec</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cuda@10.2.89%gcc@7.4.0</span>
      <span class="nt">modules</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cuda/10.2/10.2.89</span>
<span class="l l-Scalar l-Scalar-Plain">(snip)</span>
  <span class="l l-Scalar l-Scalar-Plain">openmpi</span><span class="p p-Indicator">:</span>
    <span class="nt">externals</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">spec</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">openmpi@2.1.6%gcc@4.8.5</span>
      <span class="nt">prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/apps/openmpi/2.1.6/gcc4.8.5</span>
    <span class="p p-Indicator">-</span> <span class="nt">spec</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">openmpi@2.1.6%gcc@7.4.0</span>
      <span class="nt">prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/apps/openmpi/2.1.6/gcc7.4.0</span>
<span class="l l-Scalar l-Scalar-Plain">(snip)</span>
</code></pre></div>

<p>After you copy this file, when you let Spack install CUDA version 10.2.89, it use <code>cuda/10.2/10.2.89</code> environment module, instead of installing another copy of CUDA.
<code>buildable: false</code> defined under CUDA section prohibits Spack to install other versions of CUDA specified here.
If you let Spack install versions of CUDA which are not supported by ABCI, remove this directive.</p>
<p>Because of an interpretation bug of package dependencies in <code>packages.yaml</code> of the current Spack, CUDA-aware OpenMPI supported by ABCI can not be registered.
Therefore, <code>packages.yaml</code> provided by ABCI is configured to register only non-CUDA-aware OpenMPI.
Moreover, installing a CUDA-aware OpenMPI whose version is same as a version of a registered non-CUDA-aware OpenMPI will fail.
To avoid the failure, you need to install a version which is not registered in <code>packages.yaml</code> or remove the corresponding version from <code>packages.yaml</code>.</p>
<p>Please refer to <a href="https://spack.readthedocs.io/en/latest/build_settings.html">the official document</a> for detail about <code>packages.yaml</code>.</p>
<h2 id="basic-of-spack">Basic of Spack</h2>
<p>Here is the Spack basic usage.
For detail, please refer to <a href="https://spack.readthedocs.io/en/latest/basic_usage.html">the official document</a>.</p>
<h3 id="compiler-operations">Compiler Operations</h3>
<p><code>compiler list</code> sub-command shows the list of compilers registered to Spack.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack compiler list
<span class="go">==&gt; Available compilers</span>
<span class="go">-- gcc centos7-x86_64 -------------------------------------------</span>
<span class="go">gcc@7.4.0  gcc@4.8.5</span>
</code></pre></div>

<p><code>compiler info</code> sub-command shows the detail of a specific compiler.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack compiler info gcc@4.8.5
<span class="go">gcc@4.8.5:</span>
<span class="go">    paths:</span>
<span class="go">        cc = /usr/bin/gcc</span>
<span class="go">        cxx = /usr/bin/g++</span>
<span class="go">        f77 = /usr/bin/gfortran</span>
<span class="go">        fc = /usr/bin/gfortran</span>
<span class="go">    Extra rpaths:</span>
<span class="go">        /usr/lib/gcc/x86_64-redhat-linux/4.8.5</span>
<span class="go">    modules  = []</span>
<span class="go">    operating system  = centos7</span>
</code></pre></div>

<h3 id="software-management-operations">Software Management Operations</h3>
<h4 id="install">Install</h4>
<p>The default version of OpenMPI can be installed as follows.
Refer to <a href="#cuda-aware-openmpi">Example Software Installation</a> for options.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack install openmpi <span class="nv">schedulers</span><span class="o">=</span>sge <span class="nv">fabrics</span><span class="o">=</span>auto
</code></pre></div>

<p>If you want to install a specific version, use <code>@</code> to specify the version.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack install openmpi@3.1.4 <span class="nv">schedulers</span><span class="o">=</span>sge <span class="nv">fabrics</span><span class="o">=</span>auto
</code></pre></div>

<p>The compiler to build the software can be specified by <code>%</code>.
The following example use GCC 7.4.0 for building OpenMPI.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack install openmpi@3.1.4 %gcc@7.4.0 <span class="nv">schedulers</span><span class="o">=</span>sge <span class="nv">fabrics</span><span class="o">=</span>auto
</code></pre></div>

<h4 id="uninstall">Uninstall</h4>
<p><code>uninstall</code> sub-command uninstalls installed software.
As with installation, you can uninstall software by specifying a version.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack uninstall openmpi
</code></pre></div>

<p>Each software package installed by Spack has a hash, and you can also uninstall a software by specifying a hash.
Specify <code>/</code> followed by a hash.
You can get a hash of an installed software by <code>find</code> sub-command shown in <a href="#information">Information</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack uninstall /ffwtsvk
</code></pre></div>

<p>To uninstall all the installed software, type as follows.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack uninstall --all
</code></pre></div>

<h4 id="information">Information</h4>
<p><code>list</code> sub-command shows all software which can be installed by Spack.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack list
<span class="go">abinit</span>
<span class="go">abyss</span>
<span class="gp gp-VirtualEnv">(snip)</span>
</code></pre></div>

<p>By specifying a keyword, it only shows software related to the keyword.
The following example uses <code>mpi</code> as the keyword.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack list mpi
<span class="go">==&gt; 21 packages.</span>
<span class="go">compiz       mpifileutils  mpix-launch-swift  r-rmpi        vampirtrace</span>
<span class="go">fujitsu-mpi  mpilander     openmpi            rempi</span>
<span class="go">intel-mpi    mpileaks      pbmpi              spectrum-mpi</span>
<span class="go">mpibash      mpip          pnmpi              sst-dumpi</span>
<span class="go">mpich        mpir          py-mpi4py          umpire</span>
</code></pre></div>

<p><code>find</code> sub-command shows all the installed software.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack find
<span class="go">==&gt; 49 installed packages</span>
<span class="go">-- linux-centos7-haswell / gcc@4.8.5 ----------------------------</span>
<span class="go">autoconf@2.69    gdbm@1.18.1          libxml2@2.9.9  readline@8.0</span>
<span class="gp gp-VirtualEnv">(snip)</span>
</code></pre></div>

<p>Adding <code>-dl</code> option to <code>find</code> sub-command shows hashes and dependencies of installed software.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack find -dl openmpi
<span class="go">-- linux-centos7-skylake_avx512 / gcc@7.4.0 ---------------------</span>
<span class="go">6pxjftg openmpi@3.1.1</span>
<span class="go">ahftjey     hwloc@1.11.11</span>
<span class="go">vf52amo         cuda@9.0.176.4</span>
<span class="go">edtwt6g         libpciaccess@0.16</span>
<span class="go">bt74u75         libxml2@2.9.10</span>
<span class="go">qazxaa4             libiconv@1.16</span>
<span class="go">jb22kvg             xz@5.2.5</span>
<span class="go">pkmj6e7             zlib@1.2.11</span>
<span class="go">2dq7ece         numactl@2.0.14</span>
</code></pre></div>

<p>To see the detail about a specific software, use <code>info</code> sub-command.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack info openmpi
<span class="go">AutotoolsPackage:   openmpi</span>

<span class="go">Description:</span>
<span class="go">    An open source Message Passing Interface implementation. The Open MPI</span>
<span class="go">    Project is an open source Message Passing Interface implementation that</span>
<span class="gp gp-VirtualEnv">(snip)</span>
</code></pre></div>

<p><code>versions</code> sub-command shows avaitable versions for a specific software.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack versions openmpi
<span class="go">==&gt; Safe versions (already checksummed):</span>
<span class="go">  develop  3.0.3  2.1.1   1.10.5  1.8.5  1.7.2  1.5.5  1.4.2  1.2.8  1.1.5</span>
<span class="go">  4.0.1    3.0.2  2.1.0   1.10.4  1.8.4  1.7.1  1.5.4  1.4.1  1.2.7  1.1.4</span>
<span class="go">  4.0.0    3.0.1  2.0.4   1.10.3  1.8.3  1.7    1.5.3  1.4    1.2.6  1.1.3</span>
<span class="go">  3.1.4    3.0.0  2.0.3   1.10.2  1.8.2  1.6.5  1.5.2  1.3.4  1.2.5  1.1.2</span>
<span class="go">  3.1.3    2.1.6  2.0.2   1.10.1  1.8.1  1.6.4  1.5.1  1.3.3  1.2.4  1.1.1</span>
<span class="go">  3.1.2    2.1.5  2.0.1   1.10.0  1.8    1.6.3  1.5    1.3.2  1.2.3  1.1</span>
<span class="go">  3.1.1    2.1.4  2.0.0   1.8.8   1.7.5  1.6.2  1.4.5  1.3.1  1.2.2  1.0.2</span>
<span class="go">  3.1.0    2.1.3  1.10.7  1.8.7   1.7.4  1.6.1  1.4.4  1.3    1.2.1  1.0.1</span>
<span class="go">  3.0.4    2.1.2  1.10.6  1.8.6   1.7.3  1.6    1.4.3  1.2.9  1.2    1.0</span>
</code></pre></div>

<h3 id="use-of-installed-software">Use of Installed Software</h3>
<p>Software installed with Spack is available with the <code>spack load</code> command.
Like the module provided by ABCI, the installed software can be be loaded and used.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack load xxxxx
</code></pre></div>

<p><code>spack load</code> sets environment variables, such as <code>PATH</code>, <code>MANPATH</code>, <code>CPATH</code>, <code>LD_LIBRARY_PATH</code>, so that the software can be used.</p>
<p>If you no more use, type <code>spack unload</code> to unset the variables.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack unload xxxxx
</code></pre></div>

<h3 id="using-environments">Using Environments</h3>
<p>Spack has an <em>environment</em> feature in which you can group installed software.
You can install software with different versions and dependencies in each environment, and can change software to use at once by changing environments.</p>
<p>You can create a Spack environment by <code>spack env create</code> command.
You can create multiple environments by specifying different environment names here.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack env create myenv
</code></pre></div>

<p>To activate the created environment, type <code>spack env activate</code>.
Adding <code>-p</code> option will display the current activated environment on your console.
Then, install software you need to the activated environment.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack env activate -p myenv
<span class="gp">[myenv] [username@es1 ~]$ </span>spack install xxxxx
</code></pre></div>

<p>You can deactivate the environment by <code>spack env deactivate</code>.
To switch to another environment, type <code>spack env activate</code> to activate it.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[myenv] [username@es1 ~]$ </span>spack env deactivate
<span class="gp">[username@es1 ~]$</span>
</code></pre></div>

<p>Use <code>spack env list</code> to display the list of created Spack environments.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack env list
<span class="go">==&gt; 2 environments</span>
<span class="go">    myenv</span>
<span class="go">    another_env</span>
</code></pre></div>

<h2 id="example-of-use">Example of Use</h2>
<h3 id="cuda-aware-openmpi">CUDA-aware OpenMPI</h3>
<p>ABCI provides software modules of CUDA-aware OpenMPI, however, they do not support all the combinations of compilers, CUDA and OpenMPI versions (<a href="https://docs.abci.ai/en/08/#open-mpi">Reference</a>).
It is easy to use Spack to install unsupported versions of CUDA-aware OpenMPI.</p>
<h4 id="how-to-install">How to Install</h4>
<p>This is an example of installing OpenMPI 3.1.1 that uses CUDA 10.1.243.
You have to use a compute node to install it.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@g0001 ~]$ </span>spack install cuda@10.1.243
<span class="gp">[username@g0001 ~]$ </span>spack install openmpi@3.1.1 +cuda <span class="nv">schedulers</span><span class="o">=</span>sge <span class="nv">fabrics</span><span class="o">=</span>auto ^cuda@10.1.243
<span class="gp">[username@g0001 ~]$ </span>spack find --paths openmpi@3.1.1
<span class="go">==&gt; 1 installed package</span>
<span class="go">-- linux-centos7-haswell / gcc@4.8.5 ----------------------------</span>
<span class="gp">openmpi@3.1.1  $</span><span class="o">{</span>SPACK_ROOT<span class="o">}</span>/opt/spack/linux-centos7-haswell/gcc-4.8.5/openmpi-3.1.1-4mmghhfuk5n7my7g3ko2zwzlo4wmoc5v
<span class="gp">[username@g0001 ~]$ </span><span class="nb">echo</span> <span class="s2">&quot;btl_openib_warn_default_gid_prefix = 0&quot;</span> &gt;&gt; <span class="si">${</span><span class="nv">SPACK_ROOT</span><span class="si">}</span>/opt/spack/linux-centos7-haswell/gcc-4.8.5/openmpi-3.1.1-4mmghhfuk5n7my7g3ko2zwzlo4wmoc5v/etc/openmpi-mca-params.conf
</code></pre></div>

<p>Line #1 installs CUDA version <code>10.1.243</code> so that Spack uses a CUDA provided by ABCI.
Line #2 installs OpenMPI 3.1.1 as the same configuration with <a href="../../appendix/installed-software/#open-mpi">this page</a>.
Meanings of the installation options are as follows.</p>
<ul>
<li><code>+cuda</code>: Build with CUDA support</li>
<li><code>schedulers=sge</code>: Specify how to invoke MPI processes.  You have to specify <code>sge</code> as ABCI uses Univa Grid Engine which is compatible with SGE.</li>
<li><code>fabrics=auto</code>: Specify a communication library.</li>
<li><code>^cuda@10.1.243</code>: Specify a CUDA to be used.  <code>^</code> is used to specify software dependency.</li>
</ul>
<p>Line #4 edits a configuration file to turn off runtime warnings (optional).
For this purpose, Line #3 checks the installation path of OpenMPI.</p>
<p>Spack can manage variants of the same version of software.
This is an example that you additionally install OpenMPI 3.1.1 that uses CUDA 9.0.176.4.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@g0001 ~]$ </span>spack install cuda@9.0.176.4
<span class="gp">[username@g0001 ~]$ </span>spack install openmpi@3.1.1 +cuda <span class="nv">schedulers</span><span class="o">=</span>sge <span class="nv">fabrics</span><span class="o">=</span>auto ^cuda@9.0.176.4
</code></pre></div>

<h4 id="how-to-use">How to Use</h4>
<p>This is an example of using "OpenMPI 3.1.1 that uses CUDA 10.1.243" installed above.
Specify the version of OpenMPI and CUDA dependency to load the software.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack load openmpi@3.1.1 ^cuda@10.1.243
</code></pre></div>

<p>To build an MPI program using the above OpenMPI, you need to load OpenMPI installed by Spack .</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@g0001 ~]$ </span><span class="nb">source</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/spack/share/spack/setup-env.sh
<span class="gp">[username@g0001 ~]$ </span>spack load openmpi@3.1.1 ^cuda@10.1.243
<span class="gp">[username@g0001 ~]$ </span>mpicc ...
</code></pre></div>

<p>A job script that runs the built MPI program is as follows.</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#$-l rt_F=2</span>
<span class="c1">#$-j y</span>
<span class="c1">#$-cwd</span>

<span class="nb">source</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/spack/share/spack/setup-env.sh
spack load openmpi@3.1.1 ^cuda@10.1.243

<span class="nv">NUM_NODES</span><span class="o">=</span><span class="si">${</span><span class="nv">NHOSTS</span><span class="si">}</span>
<span class="nv">NUM_GPUS_PER_NODE</span><span class="o">=</span><span class="m">4</span>
<span class="nv">NUM_PROCS</span><span class="o">=</span><span class="k">$(</span>expr <span class="si">${</span><span class="nv">NUM_NODES</span><span class="si">}</span> <span class="se">\*</span> <span class="si">${</span><span class="nv">NUM_GPUS_PER_NODE</span><span class="si">}</span><span class="k">)</span>
<span class="nv">MPIOPTS</span><span class="o">=</span><span class="s2">&quot;-n </span><span class="si">${</span><span class="nv">NUM_PROCS</span><span class="si">}</span><span class="s2"> -map-by ppr:</span><span class="si">${</span><span class="nv">NUM_GPUS_PER_NODE</span><span class="si">}</span><span class="s2">:node -x PATH -x LD_LIBRARY_PATH&quot;</span>
mpiexec <span class="si">${</span><span class="nv">MPIOPTS</span><span class="si">}</span> YOUR_PROGRAM
</code></pre></div>

<p>If you no more use the OpenMPI, you can uninstall it by specifying the version and dependencies.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack uninstall openmpi@3.1.1 ^cuda@10.1.243
</code></pre></div>

<h3 id="cuda-aware-mvapich2">CUDA-aware MVAPICH2</h3>
<p>MVAPICH2 modules provided by ABCI does not support CUDA.
If you want to use CUDA-aware MVAPICH2, install by yourself referring to the documents below.</p>
<p>You have to use a compute node to build CUDA-aware MVAPICH2.
As with <a href="#cuda-aware-openmpi">OpenMPI</a> above, you first install CUDA and then install MVAPICH2 by enabling CUDA (<code>+cuda</code>) and specifying a communication library (<code>fabrics=mrail</code>) and CUDA dependency (<code>^cuda@10.1.243</code>).</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@g0001 ~]$ </span>spack install cuda@10.1.243
<span class="gp">[username@g0001 ~]$ </span>spack install mvapich2@2.3.2 +cuda <span class="nv">fabrics</span><span class="o">=</span>mrail ^cuda@10.1.243
</code></pre></div>

<p>To use CUDA-aware MVAPICH2, as with OpenMPI, load modules of a CUDA and the installed MVAPICH2.
Here is a job script example.</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#$-l rt_F=2</span>
<span class="c1">#$-j y</span>
<span class="c1">#$-cwd</span>

<span class="nb">source</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/spack/share/spack/setup-env.sh
spack load mvapich2@2.3.2 ^cuda@10.1.243

<span class="nv">NUM_NODES</span><span class="o">=</span><span class="si">${</span><span class="nv">NHOSTS</span><span class="si">}</span>
<span class="nv">NUM_GPUS_PER_NODE</span><span class="o">=</span><span class="m">4</span>
<span class="nv">NUM_PROCS</span><span class="o">=</span><span class="k">$(</span>expr <span class="si">${</span><span class="nv">NUM_NODES</span><span class="si">}</span> <span class="se">\*</span> <span class="si">${</span><span class="nv">NUM_GPUS_PER_NODE</span><span class="si">}</span><span class="k">)</span>
<span class="nv">MPIE_ARGS</span><span class="o">=</span><span class="s2">&quot;-genv MV2_USE_CUDA=1&quot;</span>
<span class="nv">MPIOPTS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MPIE_ARGS</span><span class="si">}</span><span class="s2"> -np </span><span class="si">${</span><span class="nv">NUM_PROCS</span><span class="si">}</span><span class="s2"> -ppn </span><span class="si">${</span><span class="nv">NUM_GPUS_PER_NODE</span><span class="si">}</span><span class="s2">&quot;</span>

mpiexec <span class="si">${</span><span class="nv">MPIOPTS</span><span class="si">}</span> YOUR_PROGRAM
</code></pre></div>

<h3 id="mpifileutils">MPIFileUtils</h3>
<p><a href="https://hpc.github.io/mpifileutils/">MPIFileUtils</a> a file transfer tool that uses MPI for communication between nodes.
Although manually installing it is messy as it depends on many libraries, using Spack enables an easy install of MPIFileUtils.</p>
<p>The following example installs MPIFileUtils that uses OpenMPI 2.1.6.
Line #1 installs OpenMPI, and Line #2 installs MPIFileUtils by specifying a dependency on OpenMPI.
If you copied <code>packages.yaml</code> as described in <a href="#adding-abci-software">Adding ABCI Software</a>, OpenMPI 2.1.6 provided by ABCI is used.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack install openmpi@2.1.6
<span class="gp">[username@es1 ~]$ </span>spack install mpifileutils ^openmpi@2.1.6
</code></pre></div>

<p>To use MPIFileUtils, you have to load modules of OpenMPI 2.1.6 and MPIFileUtils.
When you load MPIFileUtils module, PATH to program, such as <code>dbcast</code> is set.
This is an example job script.</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#$-l rt_F=2</span>
<span class="c1">#$-j y</span>
<span class="c1">#$-cwd</span>

<span class="nb">source</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/spack/share/spack/setup-env.sh
spack load mpifileutils@0.10.1 ^openmpi@2.1.6

<span class="nv">NPPN</span><span class="o">=</span><span class="m">5</span>
<span class="nv">NMPIPROC</span><span class="o">=</span><span class="k">$((</span> <span class="nv">$NHOSTS</span> <span class="o">*</span> <span class="nv">$NPPN</span> <span class="k">))</span>
<span class="nv">SRC_FILE</span><span class="o">=</span>name_of_file
<span class="nv">DST_FILE</span><span class="o">=</span>name_of_file

mpiexec -n <span class="si">${</span><span class="nv">NMPIPROC</span><span class="si">}</span> -map-by ppr:<span class="si">${</span><span class="nv">NPPN</span><span class="si">}</span>:node dbcast <span class="nv">$SRC_FILE</span> <span class="nv">$DST_FILE</span>
</code></pre></div>

<h3 id="build-singularity-image-from-environment">Build Singularity Image from Environment</h3>
<p>You can create a Singularity image from a Spack environment created referring <a href="#using-environments">Using environments</a>.
The following example creates an environment named <code>myenv</code>, installs CUDA-aware OpenMPI and creates a Singularity image from the environment.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack env create myenv
<span class="gp">[username@es1 ~]$ </span>spack activate -p myenv
<span class="gp">[myenv] [username@es1 ~]$ </span>openmpi +cuda <span class="nv">schedulers</span><span class="o">=</span>sge <span class="nv">fabrics</span><span class="o">=</span>auto
<span class="gp">[username@es1 ~]$ </span>cp -p <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/spack/var/spack/environments/myenv/spack.yaml .
<span class="gp">[username@es1 ~]$ </span>vi spack.yaml
</code></pre></div>

<p>Edit <code>spack.yaml</code> as follows.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># This is a Spack Environment file.</span>
<span class="c1">#</span>
<span class="c1"># It describes a set of packages to be installed, along with</span>
<span class="c1"># configuration settings.</span>
<span class="nt">spack</span><span class="p">:</span>
  <span class="c1"># add package specs to the `specs` list</span>
  <span class="nt">specs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">openmpi +cuda fabrics=auto schedulers=sge</span><span class="p p-Indicator">]</span>
  <span class="nt">view</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>                       <span class="c1"># &lt;- Delete this line</span>

  <span class="nt">container</span><span class="p">:</span>                       <span class="c1"># &lt;- Add this line</span>
    <span class="nt">images</span><span class="p">:</span>                        <span class="c1"># &lt;- Add this line</span>
      <span class="nt">build</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">spack/centos7:0.16.0</span>  <span class="c1"># &lt;- Add this line</span>
      <span class="nt">final</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">spack/centos7:0.16.0</span>  <span class="c1"># &lt;- Add this line</span>
    <span class="nt">format</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">singularity</span>            <span class="c1"># &lt;- Add this line</span>
    <span class="nt">strip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>                   <span class="c1"># &lt;- Add this line</span>
</code></pre></div>

<p>Create a Singularity recipe file (myenv.def) from <code>spack.yaml</code> using <code>spack containerize</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">[username@es1 ~]$ </span>spack containerize &gt; myenv.def
</code></pre></div>

<p>To create a Singularity image from the generated recipe file on ABCI, please refer to <a href="../../09/#create-a-singularity-image-build">Create a Singularity image (build)</a>.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../sregistry-cli/" title="Singularity Global Client" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Singularity Global Client
              </span>
            </div>
          </a>
        
        
          <a href="../datasets/" title="Datasets" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Datasets
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 National Institute of Advanced Industrial Science and Technology (AIST)
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:"../.."}})</script>
      
    
  </body>
</html>